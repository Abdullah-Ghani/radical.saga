<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    

    <title>1. Writing SAGA-Python Adaptors &mdash; SAGA 0.9.13 documentation</title>

<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>


    
    <link rel="stylesheet" href="../_static/rtd.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.9.13',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/searchtools.js"></script>
    <link rel="top" title="SAGA 0.9.13 documentation" href="../index.html" />
    <link rel="up" title="5. Developer Documentation" href="index.html" />
    <link rel="prev" title="5. Developer Documentation" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="index.html" title="5. Developer Documentation"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">SAGA 0.9.13 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">5. Developer Documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="writing-saga-python-adaptors">
<h1>1. Writing SAGA-Python Adaptors<a class="headerlink" href="#writing-saga-python-adaptors" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This part of the SAGA-Python documentation is not for <em>users</em> of SAGA-Python,
but rather for implementors of backend adaptors (although it may be
beneficial for users to skim over section <a class="reference internal" href="#adaptor-binding"><em>Adaptor Binding</em></a> to gain
some insight into SAGA-Python&#8217;s  mode of operation).</p>
</div>
<div class="section" id="adaptor-structure">
<span id="id1"></span><h2>1.1. Adaptor Structure<a class="headerlink" href="#adaptor-structure" title="Permalink to this headline">¶</a></h2>
<p>A SAGA-Python adaptor is a Python module with well defined structure.  The
module must expose a class <tt class="docutils literal"><span class="pre">Adaptor</span></tt>, which (a) must be a singleton, (b) must
provide a <tt class="docutils literal"><span class="pre">sanity_check()</span></tt> method, and (c) must inherit from
<tt class="xref py py-class docutils literal"><span class="pre">saga.cpi.AdaptorBase</span></tt>.  That base class&#8217; constructor (<tt class="docutils literal"><span class="pre">__init__</span></tt>)
must be called like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Adaptor</span> <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">AdaptorBase</span><span class="p">):</span>

  <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">Singleton</span>

  <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">AdaptorBase</span><span class="o">.</span><span class="n">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_ADAPTOR_INFO</span><span class="p">,</span> <span class="n">_ADAPTOR_OPTIONS</span><span class="p">)</span>


  <span class="k">def</span> <span class="nf">sanity_check</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
    <span class="c"># FIXME: detect gsissh tool</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">_ADAPTOR_INFO</span></tt> and <tt class="docutils literal"><span class="pre">_ADAPTOR_OPTIONS</span></tt> are module level Python <a class="reference external" href="http://docs.python.org/library/stdtypes.html#dict" title="(in Python v2.7)"><tt class="xref py py-class docutils literal"><span class="pre">dict</span></tt></a>s with the
following layout:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">_ADAPTOR_NAME</span>          <span class="o">=</span> <span class="s">&#39;saga.adaptor.gsissh.job&#39;</span>
<span class="n">_ADAPTOR_SCHEMAS</span>       <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ssh&#39;</span><span class="p">,</span> <span class="s">&#39;gsissh&#39;</span><span class="p">]</span>
<span class="n">_ADAPTOR_OPTIONS</span>       <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
  <span class="s">&#39;category&#39;</span>         <span class="p">:</span> <span class="n">_ADAPTOR_NAME</span><span class="p">,</span>
  <span class="s">&#39;name&#39;</span>             <span class="p">:</span> <span class="s">&#39;cache_connection&#39;</span><span class="p">,</span>
  <span class="s">&#39;type&#39;</span>             <span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
  <span class="s">&#39;default&#39;</span>          <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
  <span class="s">&#39;valid_options&#39;</span>    <span class="p">:</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">],</span>
  <span class="s">&#39;documentation&#39;</span>    <span class="p">:</span> <span class="s">&#39;toggle connection caching&#39;</span><span class="p">,</span>
  <span class="s">&#39;env_variable&#39;</span>     <span class="p">:</span> <span class="bp">None</span>
  <span class="p">},</span>
<span class="p">]</span>
<span class="n">_ADAPTOR_INFO</span>          <span class="o">=</span> <span class="p">{</span>
  <span class="s">&#39;name&#39;</span>             <span class="p">:</span> <span class="n">_ADAPTOR_NAME</span><span class="p">,</span>
  <span class="s">&#39;version&#39;</span>          <span class="p">:</span> <span class="s">&#39;v0.1&#39;</span><span class="p">,</span>
  <span class="s">&#39;cpis&#39;</span>             <span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
    <span class="s">&#39;type&#39;</span>         <span class="p">:</span> <span class="s">&#39;saga.job.Service&#39;</span><span class="p">,</span>
    <span class="s">&#39;class&#39;</span>        <span class="p">:</span> <span class="s">&#39;GSISSHJobService&#39;</span><span class="p">,</span>
    <span class="s">&#39;schemas&#39;</span>      <span class="p">:</span> <span class="n">_ADAPTOR_SCHEMAS</span>
    <span class="p">},</span>
    <span class="p">{</span>
    <span class="s">&#39;type&#39;</span>         <span class="p">:</span> <span class="s">&#39;saga.job.Job&#39;</span><span class="p">,</span>
    <span class="s">&#39;class&#39;</span>        <span class="p">:</span> <span class="s">&#39;GSISSHJob&#39;</span><span class="p">,</span>
    <span class="s">&#39;schemas&#39;</span>      <span class="p">:</span> <span class="n">_ADAPTOR_SCHEMAS</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>(It is beneficial to specify <tt class="docutils literal"><span class="pre">_ADAPTOR_NAME</span></tt> and <tt class="docutils literal"><span class="pre">_ADAPTOR_SCHEMAS</span></tt>
separately, as they are used in multiple places, as explained later on.)</p>
<p>The <em>adaptor classes</em> listed in the <tt class="docutils literal"><span class="pre">_ADAPTOR_INFO</span></tt> (in this example,
<tt class="docutils literal"><span class="pre">GSISSHJob</span></tt> and <tt class="docutils literal"><span class="pre">GSISSHJobService</span></tt>) are the classes which are actually bound
to a SAGA API object, and provide its functionality.  For that purpose, those
classes must inherit the respective object&#8217;s Capability Provider Interface
(CPI), as shown in the stub below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">GSISSHJobService</span> <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Service</span><span class="p">)</span> <span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">,</span> <span class="s">&#39;GSISSHJobService&#39;</span><span class="p">)</span>


  <span class="nd">@SYNC</span>
  <span class="k">def</span> <span class="nf">init_instance</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rm_url</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_rm</span>      <span class="o">=</span> <span class="n">rm_url</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">session</span>
</pre></div>
</div>
<p>The <tt class="xref py py-class docutils literal"><span class="pre">saga.cpi.Base</span></tt> class will make sure that the adaptor classes keep
a <tt class="docutils literal"><span class="pre">self._adaptor</span></tt> member, pointing to the adaptor singleton instance (i.e. the
module&#8217;s <tt class="docutils literal"><span class="pre">Adaptor</span></tt> class instance).  It will further initialize a logging module
(available as <tt class="docutils literal"><span class="pre">self._logger</span></tt>).</p>
<p>Note that the adaptor class&#8217; <tt class="docutils literal"><span class="pre">__init__</span></tt> does not correspond to the API level
object <tt class="docutils literal"><span class="pre">__init__</span></tt> &#8211; instead, the adaptor class construction is a two step
process, and the actual constructor semantics is mapped to an
<tt class="docutils literal"><span class="pre">init_instance()</span></tt> method, which receives the API level constructor arguments.</p>
</div>
<div class="section" id="adaptor-registration">
<span id="id2"></span><h2>1.2. Adaptor Registration<a class="headerlink" href="#adaptor-registration" title="Permalink to this headline">¶</a></h2>
<p>Any SAGA adaptor must be registered in the :ref:<tt class="docutils literal"><span class="pre">Engine</span></tt> in order to be
usable.  That process is very simple, and performed by the
<tt class="xref py py-class docutils literal"><span class="pre">saga.cpi.AdaptorBase</span></tt> class &#8211; so all the adaptor has to take care
of is the correct initialization of that base class, as described in
<a class="reference internal" href="#adaptor-structure"><em>Adaptor Structure</em></a>.  The <tt class="docutils literal"><span class="pre">AdaptorBase</span></tt> will forward the
<tt class="docutils literal"><span class="pre">_ADAPTOR_INFO</span></tt> to the <tt class="xref py py-class docutils literal"><span class="pre">saga.engine.Engine</span></tt> class, where the adaptor
will be added to a registry of adaptor classes, hierarchically sorted like
this (simplified):</p>
<div class="highlight-python"><pre>Engine._adaptor_registry =
{
  'saga.job.Service' :
  {
    'gshiss' : [saga.adaptors.gsissh.job.GSISSHJobService, ...]
    'ssh'    : [saga.adaptors.gsissh.job.GSISSHJobService, ...]
    'gram'   : [saga.adaptors.globus.job.GRAMJobService, ...]
    ...
  },
  'saga.job.Job' :
  {
    'gshiss' : [saga.adaptors.gsissh.job.GSISSHJob, ...]
    'ssh'    : [saga.adaptors.gsissh.job.GSISSHJob, ...]
    'gram'   : [saga.adaptors.globus.job.GRAMJob, ...]
    ...
  },
  ...
}</pre>
</div>
<p>That registry is searched when the engine binds an adaptor class instance to
a SAGA API object instance &#8211; see <a class="reference internal" href="#adaptor-binding"><em>Adaptor Binding</em></a>.</p>
</div>
<div class="section" id="adaptor-binding">
<span id="id3"></span><h2>1.3. Adaptor Binding<a class="headerlink" href="#adaptor-binding" title="Permalink to this headline">¶</a></h2>
<p>Whenever a SAGA API object is created, or whenever any method is invoked on that
object, the SAGA-Python implementation needs to (a) select a suitable backend
adaptor to perform that operation, and (b) invoke the respective adaptor
functionality.</p>
<p>The first part, selecting a specific adaptor for a specific API
object instance, is called <em>binding</em> &#8211; SAGA-Python binds an adaptor to an
object exactly once, at creation time, and the bond remains valid for the
lifetime of the API object: on API creation, the API object will request
a suitable adaptor from the engine, and will keep it for further method
invocations (code simplified):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Service</span> <span class="p">(</span><span class="nb">object</span><span class="p">)</span> <span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span>  <span class="o">=</span> <span class="n">getEngine</span> <span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_adaptor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">get_adaptor</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;saga.job.Service&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>
                                                <span class="n">url</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">run_job</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptor</span><span class="o">.</span><span class="n">run_job</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">)</span>

  <span class="o">...</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">Engine.get_adaptor</span></tt> call will iterate through the engine&#8217;s adaptor
registry, and will, for all adaptors which indicated support for the given URL
scheme, request an adaptor class instance for the given API class.  If an
adaptor class instance can successfully be created, the engine will further
attempt to call the adaptor class&#8217; <tt class="docutils literal"><span class="pre">init_instance</span></tt> method, which will in fact
construct an adaptor level representation of the API level object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">GSISSHJobService</span> <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Service</span><span class="p">)</span> <span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">,</span> <span class="s">&#39;GSISSHJobService&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">init_instance</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="p">:</span>
    <span class="c"># - check if session contains suitable security tokens for (gsi)ssh</span>
    <span class="c"># - check if endpoint given by &#39;url&#39; can be served</span>
    <span class="c"># - establish and cache connection to that endpoint, with the sesssion</span>
    <span class="c">#   credentials</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>If either the adaptor class instantiation or the <tt class="docutils literal"><span class="pre">init_instance</span></tt> invocation
raise an exception, the engine will try the next registered adaptor for that API
class / url scheme combo.  If both steps are successful, the adaptor class
instance will be returned to the API object&#8217;s constructor, as shown above.</p>
</div>
<div class="section" id="adaptor-state">
<span id="id4"></span><h2>1.4. Adaptor State<a class="headerlink" href="#adaptor-state" title="Permalink to this headline">¶</a></h2>
<p>Instances of adaptor classes will often need to share some state.  For example,
different instances of <tt class="docutils literal"><span class="pre">saga.job.Job</span></tt> running via ssh on a specific host may
want to share a single ssh connection; asynchronous operations on a specific
adaptor may want to share a thread pool; adaptor class instances of a specific
resource adaptor may want to share a notification endpoint.  State sharing
supports scalability, and can simplify adaptor code &#8211; but also adds some
overhead to exchange and synchronize state between those adaptor class
instances.</p>
<p>The preferred way to share state is to use the adaptor instance (as it was
created by the engine while loading the adaptor&#8217;s module) for state exchange
(see section <a class="reference internal" href="#adaptor-registration"><em>Adaptor Registration</em></a> &#8211; all adaptor class instances get the
spawning adaptor instance passed at creation time:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">GSISSHJobService</span> <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Service</span><span class="p">)</span> <span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">,</span> <span class="s">&#39;GSISSHJobService&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><tt class="xref py py-class docutils literal"><span class="pre">saga.cpi.Base</span></tt> will make that instance available as <tt class="docutils literal"><span class="pre">self._adaptor</span></tt>.
As that adaptor class is part of the adaptor modules code base, and thus under
full control of the adaptor developer, it is straight forward to use it for
state caching and state exchange.  Based on the example code in section
<a class="reference internal" href="#adaptor-structure"><em>Adaptor Structure</em></a>, a connection caching adaptor class could look like
this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Adaptor</span> <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">AdaptorBase</span><span class="p">):</span>

  <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">Singleton</span>

  <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">AdaptorBase</span><span class="o">.</span><span class="n">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_ADAPTOR_INFO</span><span class="p">,</span> <span class="n">_ADAPTOR_OPTIONS</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="o">...</span>
  <span class="o">...</span>


<span class="k">class</span> <span class="nc">GSISSHJobService</span> <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Service</span><span class="p">)</span> <span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">)</span> <span class="p">:</span>
    <span class="o">...</span>
    <span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">,</span> <span class="s">&#39;GSISSHJobService&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptor</span><span class="o">.</span><span class="n">_cache</span>


  <span class="nd">@SYNC</span>
  <span class="k">def</span> <span class="nf">init_instance</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rm_url</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="p">:</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptor</span><span class="o">.</span><span class="n">keys</span> <span class="p">()</span> <span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_rm</span><span class="p">]</span> <span class="o">=</span> <span class="n">setup_connection</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rm</span><span class="p">)</span>


  <span class="nd">@SYNC</span>
  <span class="k">def</span> <span class="nf">run_job</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">:</span>
    <span class="o">...</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_rm</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="n">run</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
  <span class="o">...</span>
</pre></div>
</div>
<p>The adaptor implementor is responsible for the consistency of the shared state,
and may need to use locking to ensure proper consistency in multithreaded
environments &#8211; the <tt class="docutils literal"><span class="pre">self._adaptor</span></tt> class merely provides a shared container
for the data, nothing else.  Also, the Adaptor class&#8217; destructor should take
care of freeing the cached / shared state objects (unless another cleanup
mechanism is in place).</p>
</div>
<div class="section" id="creating-api-objects">
<span id="adaptor-apicreate"></span><h2>1.5. Creating API Objects<a class="headerlink" href="#creating-api-objects" title="Permalink to this headline">¶</a></h2>
<p>Several SAGA API objects feature factory-like methods &#8211; examples are
<tt class="docutils literal"><span class="pre">Directory.open()</span></tt>, <tt class="docutils literal"><span class="pre">job.Service.create_job()/run_job()</span></tt>, and
<tt class="docutils literal"><span class="pre">resource.Manager.aquire()</span></tt>.  To correctly implement those methods on adaptor
level, adaptors need to be able to instantiate the API objects to return.  We
have seen in section <a class="reference internal" href="#adaptor-binding"><em>Adaptor Binding</em></a> that, on API object creation, the
<tt class="docutils literal"><span class="pre">Engine</span></tt> will select and bind a suitable adaptor to the object instance.  In
many cases, however, an implementation of a factory-like API method will want to
make sure that the resulting API object is bound to the same adaptor instance as
the spawning adaptor class instance itself.  For that purpose, all API object
constructors will accept two additional parameters: <tt class="docutils literal"><span class="pre">_adaptor</span></tt> (type:
<tt class="xref py py-class docutils literal"><span class="pre">saga.cpi.Base</span></tt> or derivative), and <tt class="docutils literal"><span class="pre">_adaptor_state</span></tt> (type:
<a class="reference external" href="http://docs.python.org/library/stdtypes.html#dict" title="(in Python v2.7)"><tt class="xref py py-class docutils literal"><span class="pre">dict</span></tt></a>).  This is also provided for API objects which normally have no
public constructor at all:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Job</span> <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">Attributes</span><span class="p">,</span> <span class="n">saga</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">Async</span><span class="p">)</span> <span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_adaptor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">_adaptor_state</span><span class="o">=</span><span class="p">{})</span> <span class="p">:</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_adaptor</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">IncorrectState</span> <span class="p">(</span><span class="s">&quot;saga.job.Job constructor is private&quot;</span><span class="p">)</span>
    <span class="o">...</span>

    <span class="c"># bind to the given adaptor -- this will create the required adaptor</span>
    <span class="c"># class.  We need to specify a schema for adaptor selection -- and</span>
    <span class="c"># simply choose the first one the adaptor offers.</span>
    <span class="n">engine</span>         <span class="o">=</span> <span class="n">getEngine</span> <span class="p">()</span>
    <span class="n">adaptor_schema</span> <span class="o">=</span> <span class="n">_adaptor</span><span class="o">.</span><span class="n">get_schemas</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_adaptor</span>  <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">bind_adaptor</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;saga.job.Job&#39;</span><span class="p">,</span> <span class="n">adaptor_schema</span><span class="p">,</span>
                                          <span class="n">saga</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">NOTASK</span><span class="p">,</span> <span class="n">_adaptor</span><span class="p">,</span> <span class="n">_adaptor_state</span><span class="p">)</span>
</pre></div>
</div>
<p>As shown above, <tt class="docutils literal"><span class="pre">_adaptor</span></tt> and <tt class="docutils literal"><span class="pre">_adaptor_state</span></tt> are forwarded to the
Engine&#8217;s <tt class="docutils literal"><span class="pre">bind_adaptor()</span></tt> method, and if present will ensure that the
resulting API object is bound to the given adaptor.  The <tt class="docutils literal"><span class="pre">_adaptor_state</span></tt> dict
will be forwarded to the adaptor class level <tt class="docutils literal"><span class="pre">init_instance()</span></tt> call, and can
be used to correctly initialize the state of the new adaptor class.  An example
of adaptor level code for creating an <a class="reference internal" href="../library/job/index.html#saga.job.Job" title="saga.job.Job"><tt class="xref py py-class docutils literal"><span class="pre">saga.job.Job</span></tt></a> instance via
<a class="reference internal" href="../library/job/index.html#saga.job.Service" title="saga.job.Service"><tt class="xref py py-class docutils literal"><span class="pre">saga.job.Service</span></tt></a><tt class="docutils literal"><span class="pre">.create_job()</span></tt> is below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">GSISSHJobService</span> <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Service</span><span class="p">)</span> <span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">)</span> <span class="p">:</span>
      <span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">,</span> <span class="s">&#39;GSISSHJobService&#39;</span><span class="p">)</span>

  <span class="nd">@SYNC</span>
  <span class="k">def</span> <span class="nf">init_instance</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rm_url</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="p">:</span>
    <span class="o">...</span>

  <span class="nd">@SYNC</span>
  <span class="k">def</span> <span class="nf">create_job</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jd</span><span class="p">)</span> <span class="p">:</span>

    <span class="n">state</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;job_service&#39;</span>     <span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
              <span class="s">&#39;job_description&#39;</span> <span class="p">:</span> <span class="n">jd</span><span class="p">,</span>
              <span class="s">&#39;session&#39;</span>         <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">saga</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Job</span> <span class="p">(</span><span class="n">_adaptor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_adaptor</span><span class="p">,</span> <span class="n">_adaptor_state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GSISSHJob</span> <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Job</span><span class="p">)</span> <span class="p">:</span>
  <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">,</span> <span class="s">&#39;GSISSHJob&#39;</span><span class="p">)</span>
    <span class="o">...</span>

  <span class="nd">@SYNC</span>
  <span class="k">def</span> <span class="nf">init_instance</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_info</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span>        <span class="o">=</span> <span class="n">job_info</span><span class="p">[</span><span class="s">&#39;session&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_jd</span>             <span class="o">=</span> <span class="n">job_info</span><span class="p">[</span><span class="s">&#39;job_description&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parent_service</span> <span class="o">=</span> <span class="n">job_info</span><span class="p">[</span><span class="s">&#39;job_service&#39;</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>             <span class="o">=</span> <span class="bp">None</span> <span class="c"># is assigned when calling job.run()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>          <span class="o">=</span> <span class="n">saga</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">NEW</span>

    <span class="c"># register ourselves with the parent service</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parent_service</span><span class="o">.</span><span class="n">_update_jobid</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="exception-handling">
<span id="adaptor-exceptions"></span><h2>1.6. Exception Handling<a class="headerlink" href="#exception-handling" title="Permalink to this headline">¶</a></h2>
<p>SAGA-Python defines a set of exceptions which can be thrown on the various
method invocations (see section <em class="xref std std-ref">api_exceptions</em>.  Adaptor implementors
must ensure, that the correct exception types are thrown on the corresponding
error conditions.  If the API layer encounters a non-SAGA exception from the
adaptor layer, it will convert it to a <tt class="docutils literal"><span class="pre">saga.NoSuccess</span></tt> exception.  While that
will reliably shield the user layer from non-SAGA exception types, it is a lossy
translation, and likely to hide the underlying cause of the error.  This feature
is thus to be considered as a safe guard, not as a preferred method of error
state communication!</p>
<p>An example of adaptor level error handling is below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ContextX509</span> <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">,</span> <span class="s">&#39;ContextX509&#39;</span><span class="p">)</span>

  <span class="nd">@SYNC</span>
  <span class="k">def</span> <span class="nf">init_instance</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="o">.</span><span class="n">lower</span> <span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">_ADAPTOR_SCHEMAS</span><span class="p">)</span> <span class="p">:</span>
      <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BadParameter</span> \
              <span class="p">(</span><span class="s">&quot;the x509 context adaptor only handles x509 contexts - duh!&quot;</span><span class="p">)</span>

  <span class="nd">@SYNC</span>
  <span class="k">def</span> <span class="nf">_initialize</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="p">:</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">user_proxy</span> <span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">user_proxy</span> <span class="o">=</span> <span class="s">&quot;x509up_u</span><span class="si">%d</span><span class="s">&quot;</span>  <span class="o">%</span>  <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span>   <span class="c"># fallback</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">user_proxy</span><span class="p">)</span> <span class="ow">or</span> \
       <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">user_proxy</span><span class="p">)</span>    <span class="p">:</span>
      <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BadParameter</span> <span class="p">(</span><span class="s">&quot;X509 proxy does not exist: </span><span class="si">%s</span><span class="s">&quot;</span>
                                               <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">user_proxy</span><span class="p">)</span>

    <span class="k">try</span> <span class="p">:</span>
      <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">user_proxy</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">PermissionDenied</span> <span class="p">(</span><span class="s">&quot;X509 proxy &#39;</span><span class="si">%s</span><span class="s">&#39; not readable: </span><span class="si">%s</span><span class="s">&quot;</span>
                                           <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">user_proxy</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="k">else</span> <span class="p">:</span>
      <span class="n">fh</span><span class="o">.</span><span class="n">close</span> <span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="asynchronous-methods">
<span id="adaptor-async"></span><h2>1.7. Asynchronous Methods<a class="headerlink" href="#asynchronous-methods" title="Permalink to this headline">¶</a></h2>
<p>The SAGA API features several objects which implement both synchronous and
asynchronous versions of their respective methods.  Synchronous calls will
return normal objects or values; asynchronous calls will return
<tt class="xref py py-class docutils literal"><span class="pre">saga.Task</span></tt> instances, which represent the ongoing asynchronous method,
and can later be inspected for state and return values.</p>
<p>On adaptor level, both method types are differences by the method decorators
<tt class="docutils literal"><span class="pre">&#64;SYNC</span></tt> and <tt class="docutils literal"><span class="pre">&#64;ASYNC</span></tt>, like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">LocalFile</span> <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">File</span><span class="p">)</span> <span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">)</span> <span class="p">:</span>
      <span class="n">saga</span><span class="o">.</span><span class="n">cpi</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">adaptor</span><span class="p">,</span> <span class="s">&#39;LocalFile&#39;</span><span class="p">)</span>

  <span class="nd">@SYNC</span>
  <span class="k">def</span> <span class="nf">init_instance</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_url</span>     <span class="o">=</span> <span class="n">url</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span>   <span class="o">=</span> <span class="n">flags</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">session</span>
      <span class="o">...</span>


  <span class="nd">@ASYNC</span>
  <span class="k">def</span> <span class="nf">init_instance_async</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ttype</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_url</span>     <span class="o">=</span> <span class="n">url</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span>   <span class="o">=</span> <span class="n">flags</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">session</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">saga</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span> <span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">_set_result</span> <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">File</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">_adaptor_name</span><span class="o">=</span><span class="n">_ADAPTOR_NAME</span><span class="p">))</span>
    <span class="n">t</span><span class="o">.</span><span class="n">_set_state</span>  <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">DONE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">t</span>


  <span class="nd">@SYNC</span>
  <span class="k">def</span> <span class="nf">get_url</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span>

  <span class="nd">@ASYNC</span>
  <span class="k">def</span> <span class="nf">get_url_async</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ttype</span><span class="p">)</span> <span class="p">:</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">saga</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span> <span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">_set_result</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">_set_state</span>  <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">DONE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">t</span>
</pre></div>
</div>
<p>Note that the async calls in the example code above are not <em>really</em>
asynchronous, as they both return a task which is in <tt class="docutils literal"><span class="pre">Done</span></tt> state &#8211; a proper
async call would return a task in <tt class="docutils literal"><span class="pre">New</span></tt> or <tt class="docutils literal"><span class="pre">Running</span></tt> state, without setting
the task&#8217;s result, and would perform some required work in a separate thread or
process.  Upon completion, the adaptor (which should keep a handle on the
created task) would then set the result and state of the task, thus notifying
the application of the completion of the asynchronous method call.</p>
<p>Also note that there exists an asynchronous version for the <tt class="docutils literal"><span class="pre">init_instance()</span></tt>
method, which is used for the asynchronous API object creation, i.e. on:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#import sys</span>
<span class="c">#import saga</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">saga</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">create</span> <span class="p">(</span><span class="s">&#39;ssh://host.net&#39;</span><span class="p">)</span>

<span class="n">t</span><span class="o">.</span><span class="n">wait</span> <span class="p">()</span>

<span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">saga</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">DONE</span> <span class="p">:</span>
  <span class="k">print</span> <span class="s">&quot;no job service: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">exit</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">job_service</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_result</span> <span class="p">()</span>
<span class="n">job_service</span><span class="o">.</span><span class="n">run_job</span> <span class="p">(</span><span class="s">&quot;touch /tmp/hello_world&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The exact semantics of SAGA&#8217;s asynchronous operations is described elsewhere
(see section <em class="xref std std-ref">api_tasks</em>).  Relevant for this discussion is to note that
the asynchronous adaptor methods all receive a task type parameter (<tt class="docutils literal"><span class="pre">ttype</span></tt>)
which determines the state of the task to return: on <tt class="docutils literal"><span class="pre">ttype==saga.task.TASK</span></tt>,
the returned task should be in <tt class="docutils literal"><span class="pre">New</span></tt> state; on <tt class="docutils literal"><span class="pre">ttype==saga.task.ASYNC</span></tt> the
task is in <tt class="docutils literal"><span class="pre">Running</span></tt> state, and on <tt class="docutils literal"><span class="pre">ttype==saga.task.SYNC</span></tt> the returned task
is already <tt class="docutils literal"><span class="pre">Done</span></tt>.  It is up to the adaptor implementor to ensure that
semantics &#8211; the examples above do not follow it, and are thus incomplete.</p>
</div>
<div class="section" id="bulk-operations">
<span id="adaptor-bulks"></span><h2>1.8. Bulk Operations:<a class="headerlink" href="#bulk-operations" title="Permalink to this headline">¶</a></h2>
<p>On API level, there exists no explicit support for bulk operations.  Those can,
however, be rendered implicitly, by collecting asynchronous operations in a task
container, and calling <tt class="docutils literal"><span class="pre">run()</span></tt> on that container:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">bulk</span>  <span class="o">=</span> <span class="n">saga</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">Container</span> <span class="p">()</span>

<span class="n">dir_1</span> <span class="o">=</span> <span class="n">saga</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">Directory</span> <span class="p">(</span><span class="s">&quot;gridftp://remote.host1.net/&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ranger</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">:</span>

  <span class="n">src</span> <span class="o">=</span> <span class="s">&quot;gridftp://remote.host1.net/data/file_</span><span class="si">%4d</span><span class="s">.dat&quot;</span>  <span class="o">%</span>  <span class="n">i</span>
  <span class="n">tgt</span> <span class="o">=</span> <span class="s">&quot;gridftp://other.hostx.net/share/file_</span><span class="si">%4d</span><span class="s">.dat&quot;</span>  <span class="o">%</span>  <span class="n">i</span>

  <span class="n">bulk</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">dir1</span><span class="o">.</span><span class="n">copy</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">saga</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">TASK</span><span class="p">))</span>


<span class="n">dir_2</span> <span class="o">=</span> <span class="n">saga</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">Directory</span> <span class="p">(</span><span class="s">&quot;ssh://remote.host2.net/&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ranger</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">:</span>

  <span class="n">src</span> <span class="o">=</span> <span class="s">&quot;ssh://remote.host2.net/data/file_</span><span class="si">%4d</span><span class="s">.info&quot;</span>  <span class="o">%</span>  <span class="n">i</span>
  <span class="n">tgt</span> <span class="o">=</span> <span class="s">&quot;ssh://other.hostx.net/share/file_</span><span class="si">%4d</span><span class="s">.info&quot;</span>  <span class="o">%</span>  <span class="n">i</span>

  <span class="n">bulk</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">dir2</span><span class="o">.</span><span class="n">copy</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">saga</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">TASK</span><span class="p">))</span>


<span class="n">bulk</span><span class="o">.</span><span class="n">run</span>  <span class="p">()</span>
<span class="n">bulk</span><span class="o">.</span><span class="n">wait</span> <span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
</pre></div>
</div>
<p>The above task container gets filled by file copy tasks which are addressing two
different file transfer protocols, and are thus likely mapped to two different
adaptors.  The SAGA-Python API implementation will inspect the task container
upon <tt class="docutils literal"><span class="pre">bulk.run()</span></tt>, and will attempt to sort the contained tasks by adaptor,
i.e. all tasks operating on API objects which bind to the same adaptor instance
(not adaptor class instance) will be lumped together into a task <em>bucket</em>.  For
each bucket, the API will then call the respective bulk operation
(<tt class="docutils literal"><span class="pre">container_method</span></tt>) for that adaptor.</p>
<p>Note that at this point, the task container implementation does not yet know
what <em>adaptor class</em> instance to use for the bulk operations.  For that purpose,
it will inspect</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">todo:</th><td class="field-body">Needs completion after generic bulk ops are fixed.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="adaptor-logging">
<span id="id5"></span><h2>1.9. Adaptor Logging<a class="headerlink" href="#adaptor-logging" title="Permalink to this headline">¶</a></h2>
<p>Based on Python&#8217;s <tt class="docutils literal"><span class="pre">logging</span></tt> facility, SAGA-Python also supports logging, both
as an internal auditing and debugging mechanism, and as application supporting
capability (see section <em class="xref std std-ref">util_logging</em>.  Adaptor implementors are
encouraged to use logging as well &#8211; for that purposed, the
<tt class="xref py py-class docutils literal"><span class="pre">saga.cpi.AdaptorBase</span></tt> and <tt class="xref py py-class docutils literal"><span class="pre">saga.cpi.Base</span></tt> classes will initialize
a <tt class="docutils literal"><span class="pre">self._logger</span></tt> member for all adaptor and adaptor class implementations,
respectively.</p>
<p>We advice to use the log levels as indicated below:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="37%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Log Level</th>
<th class="head">Type of Events Logged</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">CRITICAL</span></tt></td>
<td>Only fatal events that will cause
the process to abort &#8211; that
NEVER happen on adaptor level!</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">ERROR</span></tt></td>
<td>Events that will prevent the
adaptor from functioning correctly.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">WARNING</span></tt></td>
<td>Events that indicate potential
problems or unusual events, and
can support application
diagnostics.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">INFO</span></tt></td>
<td>Events that support adaptor
auditing, inform about backend
activities, performance etc.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">DEBUG</span></tt></td>
<td>Events which support the tracking
of adaptor code paths, to support
adaptor debugging (lots of output).</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="external-processes">
<span id="adaptor-process"></span><h2>1.10. External Processes<a class="headerlink" href="#external-processes" title="Permalink to this headline">¶</a></h2>
<p>For many adaptor implementations, it is beneficial to interface to external
processes.  In particular, all adaptors performing remote interactions over ssh
or gsissh secured connections will likely need to interact with the remote user
shell.  The classes <a class="reference internal" href="#saga.utils.pty_process.PTYProcess" title="saga.utils.pty_process.PTYProcess"><tt class="xref py py-class docutils literal"><span class="pre">saga.utils.pty_process.PTYProcess</span></tt></a> and (on top of
PTYProcess) <a class="reference internal" href="#saga.utils.pty_shell.PTYShell" title="saga.utils.pty_shell.PTYShell"><tt class="xref py py-class docutils literal"><span class="pre">saga.utils.pty_shell.PTYShell</span></tt></a> are designed to simplify
those interactions, and at the same time be more performant than, for example,
pexpect.</p>
<dl class="class">
<dt id="saga.utils.pty_shell.PTYShell">
<em class="property">class </em><tt class="descclassname">saga.utils.pty_shell.</tt><tt class="descname">PTYShell</tt><big>(</big><em>url</em>, <em>session=None</em>, <em>logger=None</em>, <em>init=None</em>, <em>opts={}</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <tt class="xref py py-class docutils literal"><span class="pre">object</span></tt></p>
<p>This class wraps a shell process and runs it as a <tt class="xref py py-class docutils literal"><span class="pre">PTYProcess</span></tt>.  The
user of this class can start that shell, and run arbitrary commands on it.</p>
<p>The shell to be run is expected to be POSIX compliant (bash, dash, sh, ksh
etc.) &#8211; in particular, we expect the following features:
<tt class="docutils literal"><span class="pre">$?</span></tt>,
<tt class="docutils literal"><span class="pre">$!</span></tt>,
<tt class="docutils literal"><span class="pre">$#</span></tt>,
<tt class="docutils literal"><span class="pre">$*</span></tt>,
<tt class="docutils literal"><span class="pre">$&#64;</span></tt>,
<tt class="docutils literal"><span class="pre">$$</span></tt>,
<tt class="docutils literal"><span class="pre">$PPID</span></tt>,
<tt class="docutils literal"><span class="pre">&gt;&amp;</span></tt>,
<tt class="docutils literal"><span class="pre">&gt;&gt;</span></tt>,
<tt class="docutils literal"><span class="pre">&gt;</span></tt>,
<tt class="docutils literal"><span class="pre">&lt;</span></tt>,
<tt class="docutils literal"><span class="pre">|</span></tt>,
<tt class="docutils literal"><span class="pre">||</span></tt>,
<tt class="docutils literal"><span class="pre">()</span></tt>,
<tt class="docutils literal"><span class="pre">&amp;</span></tt>,
<tt class="docutils literal"><span class="pre">&amp;&amp;</span></tt>,
<tt class="docutils literal"><span class="pre">wait</span></tt>,
<tt class="docutils literal"><span class="pre">kill</span></tt>,
<tt class="docutils literal"><span class="pre">nohup</span></tt>,
<tt class="docutils literal"><span class="pre">shift</span></tt>,
<tt class="docutils literal"><span class="pre">export</span></tt>,
<tt class="docutils literal"><span class="pre">PS1</span></tt>, and
<tt class="docutils literal"><span class="pre">PS2</span></tt>.</p>
<p>Note that <tt class="docutils literal"><span class="pre">PTYShell</span></tt> will change the shell prompts (<tt class="docutils literal"><span class="pre">PS1</span></tt> and <tt class="docutils literal"><span class="pre">PS2</span></tt>),
to simplify output parsing.  <tt class="docutils literal"><span class="pre">PS2</span></tt> will be empty, <tt class="docutils literal"><span class="pre">PS1</span></tt> will be set
<tt class="docutils literal"><span class="pre">PROMPT-$?-&gt;</span></tt> &#8211; that way, the prompt will report the exit value of the
last command, saving an extra roundtrip.  Users of this class should be
careful when setting other prompts &#8211; see <tt class="xref py py-func docutils literal"><span class="pre">set_prompt()</span></tt> for more
details.</p>
<p>Usage Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># start the shell, find its prompt.  </span>
<span class="bp">self</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="n">saga</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">PTYShell</span> <span class="p">(</span><span class="s">&quot;ssh://user@remote.host.net/&quot;</span><span class="p">,</span> <span class="n">contexts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>

<span class="c"># run a simple shell command, merge stderr with stdout.  $$ is the pid</span>
<span class="c"># of the shell instance.</span>
<span class="n">ret</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run_sync</span> <span class="p">(</span><span class="s">&quot;mkdir -p /tmp/data.$$/&quot;</span> <span class="p">)</span>

<span class="c"># check if mkdir reported success</span>
<span class="k">if</span>  <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
    <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;failed to prepare base dir (</span><span class="si">%s</span><span class="s">)(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>

<span class="c"># stage some data from a local string variable into a file on the remote system</span>
<span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">stage_to_remote</span> <span class="p">(</span><span class="n">src</span> <span class="o">=</span> <span class="n">pbs_job_script</span><span class="p">,</span> 
                            <span class="n">tgt</span> <span class="o">=</span> <span class="s">&quot;/tmp/data.$$/job_1.pbs&quot;</span><span class="p">)</span>

<span class="c"># check size of staged script (this is actually done on PTYShell level</span>
<span class="c"># already, with no extra hop):</span>
<span class="n">ret</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run_sync</span> <span class="p">(</span><span class="s">&quot;stat -c &#39;</span><span class="si">%s</span><span class="s">&#39; /tmp/data.$$/job_1.pbs&quot;</span> <span class="p">)</span>
<span class="k">if</span>  <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
    <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;failed to check size (</span><span class="si">%s</span><span class="s">)(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>

<span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pbs_job_script</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Data Staging and Data Management:</strong></p>
<p>The PTYShell class does not only support command execution, but also basic
data management: for SSH based shells, it will create a tunneled scp/sftp
connection for file staging.  Other data management operations (mkdir, size,
list, ...) are executed either as shell commands, or on the scp/sftp channel
(if possible on the data channel, to keep the shell pty free for concurrent
command execution).  Ssh tunneling is implemented via ssh.v2 &#8216;ControlMaster&#8217;
capabilities (see <cite>ssh_config(5)</cite>).</p>
<p>For local shells, PTYShell will create an additional shell pty for data
management operations.</p>
<p><strong>Asynchronous Notifications:</strong></p>
<p>A third pty process will be created for asynchronous notifications.  For
that purpose, the shell started on the first channel will create a named
pipe, at:</p>
<div class="highlight-python"><pre>$HOME/.saga/adaptors/shell/async.$$</pre>
</div>
<p><tt class="docutils literal"><span class="pre">$$</span></tt> here represents the pid of the shell process.  It will also set the
environment variable <tt class="docutils literal"><span class="pre">SAGA_ASYNC_PIPE</span></tt> to point to that named pipe &#8211; any
application running on the remote host can write event messages to that
pipe, which will be available on the local end (see below).  <cite>PTYShell</cite>
leaves it unspecified what format those messages have, but messages are
expected to be separated by newlines.</p>
<p>An adaptor using <cite>PTYShell</cite> can subscribe for messages via:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">subscribe</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
</pre></div>
</div>
<p>where callback is a Python callable.  PTYShell will listen on the event
channel <em>in a separate thread</em> and invoke that callback on any received
message, passing the message text (sans newline) to the callback.</p>
<p>An example usage: the command channel may run the following command line:</p>
<div class="highlight-python"><pre>( sh -c 'sleep 100 &amp;&amp; echo "job $$ done" &gt; $SAGA_ASYNC_PIPE"                          || echo "job $$ fail" &gt; $SAGA_ASYNC_PIPE" ) &amp;</pre>
</div>
<p>which will return immediately, and send a notification message at job
completion.</p>
<p>Note that writes to named pipes are not atomic.  From POSIX:</p>
<p><a href="#id6"><span class="problematic" id="id7">``</span></a>A write is atomic if the whole amount written in one operation is not
interleaved with data from any other process. This is useful when there are
multiple writers sending data to a single reader. Applications need to know
how large a write request can be expected to be performed atomically. This
maximum is called {PIPE_BUF}. This volume of IEEE Std 1003.1-2001 does not
say whether write requests for more than {PIPE_BUF} bytes are atomic, but
requires that writes of {PIPE_BUF} or fewer bytes shall be atomic.`</p>
<p>Thus the user is responsible for ensuring that either messages are smaller
than <em>PIPE_BUF</em> bytes on the remote system (usually at least 1024, on Linux
usually 4096), or to lock the pipe on larger writes.</p>
<p><strong>Automated Restart, Timeouts:</strong></p>
<p>For timeout and restart semantics, please see the documentation to the
underlying <a class="reference internal" href="#saga.utils.pty_process.PTYProcess" title="saga.utils.pty_process.PTYProcess"><tt class="xref py py-class docutils literal"><span class="pre">saga.utils.pty_process.PTYProcess</span></tt></a> class.</p>
<dl class="method">
<dt id="saga.utils.pty_shell.PTYShell.initialize">
<tt class="descname">initialize</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell.initialize"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell.initialize" title="Permalink to this definition">¶</a></dt>
<dd><p>initialize the shell connection.</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_shell.PTYShell.finalize">
<tt class="descname">finalize</tt><big>(</big><em>kill_pty=False</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell.finalize"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell.finalize" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="saga.utils.pty_shell.PTYShell.alive">
<tt class="descname">alive</tt><big>(</big><em>recover=False</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell.alive"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell.alive" title="Permalink to this definition">¶</a></dt>
<dd><p>The shell is assumed to be alive if the shell processes lives.
Attempt to restart shell if recover==True</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_shell.PTYShell.find_prompt">
<tt class="descname">find_prompt</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell.find_prompt"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell.find_prompt" title="Permalink to this definition">¶</a></dt>
<dd><p>If run_async was called, a command is running on the shell.  find_prompt
can be used to collect its output up to the point where the shell prompt
re-appears (i.e. when the command finishes).</p>
<p>Note that this method blocks until the command finishes.  Future
versions of this call may add a timeout parameter.</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_shell.PTYShell.find">
<tt class="descname">find</tt><big>(</big><em>patterns</em>, <em>timeout=-1</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell.find"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell.find" title="Permalink to this definition">¶</a></dt>
<dd><p>Note that this method blocks until pattern is found in the shell I/O.</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_shell.PTYShell.set_prompt">
<tt class="descname">set_prompt</tt><big>(</big><em>new_prompt</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell.set_prompt"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell.set_prompt" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>new_prompt</strong> (<a class="reference external" href="http://docs.python.org/library/string.html#module-string" title="(in Python v2.7)"><em>string</em></a>) &#8211; a regular expression matching the shell prompt</td>
</tr>
</tbody>
</table>
<p>The new_prompt regex is expected to be a regular expression with one set
of catching brackets, which MUST return the previous command&#8217;s exit
status.  This method will send a newline to the client, and expects to
find the prompt with the exit value &#8216;0&#8217;.</p>
<p>As a side effect, this method will discard all previous data on the pty,
thus effectively flushing the pty output.</p>
<p>By encoding the exit value in the command prompt, we safe one roundtrip.
The prompt on Posix compliant shells can be set, for example, via:</p>
<div class="highlight-python"><pre>PS1='PROMPT-$?-&gt;'; export PS1</pre>
</div>
<p>The newline in the example above allows to nicely anchor the regular
expression, which would look like:</p>
<div class="highlight-python"><pre>PROMPT-(\d+)-&gt;$</pre>
</div>
<p>The regex is compiled with &#8216;re.DOTALL&#8217;, so the dot character matches
all characters, including line breaks.  Be careful not to match more
than the exact prompt &#8211; otherwise, a prompt search will swallow stdout
data.  For example, the following regex:</p>
<div class="highlight-python"><pre>PROMPT-(.+)-&gt;$</pre>
</div>
<p>would capture arbitrary strings, and would thus match <em>all</em> of:</p>
<div class="highlight-python"><pre>PROMPT-0-&gt;ls
data/ info
PROMPT-0-&gt;</pre>
</div>
<p>and thus swallow the ls output...</p>
<p>Note that the string match <em>before</em> the prompt regex is non-gready &#8211; if
the output contains multiple occurrences of the prompt, only the match
up to the first occurence is returned.</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_shell.PTYShell.run_sync">
<tt class="descname">run_sync</tt><big>(</big><em>command</em>, <em>iomode=None</em>, <em>new_prompt=None</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell.run_sync"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell.run_sync" title="Permalink to this definition">¶</a></dt>
<dd><p>Run a shell command, and report exit code, stdout and stderr (all three
will be returned in a tuple).  The call will block until the command
finishes (more exactly, until we find the prompt again on the shell&#8217;s
I/O stream), and cannot be interrupted.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>command</strong> (<a class="reference external" href="http://docs.python.org/library/string.html#module-string" title="(in Python v2.7)"><em>string</em></a>) &#8211; shell command to run.</li>
<li><strong>iomode</strong> (<em>enum</em>) &#8211; Defines how stdout and stderr are captured.</li>
<li><strong>new_prompt</strong> (<a class="reference external" href="http://docs.python.org/library/string.html#module-string" title="(in Python v2.7)"><em>string</em></a>) &#8211; regular expression matching the prompt after</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>command succeeded.</p>
<p>We expect the <tt class="docutils literal"><span class="pre">command</span></tt> to not to do stdio redirection, as this is we want
to capture that separately.  We <em>do</em> allow pipes and stdin/stdout
redirection.  Note that SEPARATE mode will break if the job is run in
the background</p>
<p>The following iomode values are valid:</p>
<blockquote>
<div><ul>
<li><dl class="first docutils">
<dt><em>IGNORE:</em>   both stdout and stderr are discarded, <cite>None</cite> will be</dt>
<dd><p class="first last">returned for each.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><em>MERGED:</em>   both streams will be merged and returned as stdout; </dt>
<dd><p class="first last">stderr will be <cite>None</cite>.  This is the default.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><em>SEPARATE:</em> stdout and stderr will be captured separately, and</dt>
<dd><p class="first last">returned individually.  Note that this will require 
at least one more network hop!</p>
</dd>
</dl>
</li>
<li><p class="first"><em>STDOUT:</em>   only stdout is captured, stderr will be <cite>None</cite>.</p>
</li>
<li><p class="first"><em>STDERR:</em>   only stderr is captured, stdout will be <cite>None</cite>.</p>
</li>
<li><dl class="first docutils">
<dt><em>None:</em>     do not perform any redirection &#8211; this is effectively</dt>
<dd><p class="first last">the same as <cite>MERGED</cite></p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>If any of the requested output streams does not return any data, an
empty string is returned.</p>
<p>If the command to be run changes the prompt to be expected for the
shell, the <tt class="docutils literal"><span class="pre">new_prompt</span></tt> parameter MUST contain a regex to match the
new prompt.  The same conventions as for set_prompt() hold &#8211; i.e. we
expect the prompt regex to capture the exit status of the process.</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_shell.PTYShell.run_async">
<tt class="descname">run_async</tt><big>(</big><em>command</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell.run_async"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell.run_async" title="Permalink to this definition">¶</a></dt>
<dd><p>Run a shell command, but don&#8217;t wait for prompt &#8211; just return.  It is up
to caller to eventually search for the prompt again (see
<tt class="xref py py-func docutils literal"><span class="pre">find_prompt()</span></tt>.  Meanwhile, the caller can interact with the called
command, via the I/O channels.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>command</strong> (<a class="reference external" href="http://docs.python.org/library/string.html#module-string" title="(in Python v2.7)"><em>string</em></a>) &#8211; shell command to run.</td>
</tr>
</tbody>
</table>
<p>For async execution, we don&#8217;t care if the command is doing i/o redirection or not.</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_shell.PTYShell.send">
<tt class="descname">send</tt><big>(</big><em>data</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell.send"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell.send" title="Permalink to this definition">¶</a></dt>
<dd><p>send data to the shell.  No newline is appended!</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_shell.PTYShell.write_to_remote">
<tt class="descname">write_to_remote</tt><big>(</big><em>src</em>, <em>tgt</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell.write_to_remote"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell.write_to_remote" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>src</strong> (<a class="reference external" href="http://docs.python.org/library/string.html#module-string" title="(in Python v2.7)"><em>string</em></a>) &#8211; data to be staged into the target file</li>
<li><strong>tgt</strong> (<a class="reference external" href="http://docs.python.org/library/string.html#module-string" title="(in Python v2.7)"><em>string</em></a>) &#8211; path to target file to staged to
The tgt path is not an URL, but expected to be a path
relative to the shell&#8217;s URL.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The content of the given string is pasted into a file (specified by tgt)
on the remote system.  If that file exists, it is overwritten.
A NoSuccess exception is raised if writing the file was not possible
(missing permissions, incorrect path, etc.).</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_shell.PTYShell.read_from_remote">
<tt class="descname">read_from_remote</tt><big>(</big><em>src</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell.read_from_remote"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell.read_from_remote" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>src</strong> (<a class="reference external" href="http://docs.python.org/library/string.html#module-string" title="(in Python v2.7)"><em>string</em></a>) &#8211; path to source file to staged from
The src path is not an URL, but expected to be a path
relative to the shell&#8217;s URL.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_shell.PTYShell.stage_to_remote">
<tt class="descname">stage_to_remote</tt><big>(</big><em>src</em>, <em>tgt</em>, <em>cp_flags=''</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell.stage_to_remote"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell.stage_to_remote" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>src</strong> (<a class="reference external" href="http://docs.python.org/library/string.html#module-string" title="(in Python v2.7)"><em>string</em></a>) &#8211; path of local source file to be stage from.
The tgt path is not an URL, but expected to be a path
relative to the current working directory.</li>
<li><strong>tgt</strong> (<a class="reference external" href="http://docs.python.org/library/string.html#module-string" title="(in Python v2.7)"><em>string</em></a>) &#8211; path to target file to stage to.
The tgt path is not an URL, but expected to be a path
relative to the shell&#8217;s URL.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_shell.PTYShell.stage_from_remote">
<tt class="descname">stage_from_remote</tt><big>(</big><em>src</em>, <em>tgt</em>, <em>cp_flags=''</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_shell.html#PTYShell.stage_from_remote"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_shell.PTYShell.stage_from_remote" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>tgt</strong> (<a class="reference external" href="http://docs.python.org/library/string.html#module-string" title="(in Python v2.7)"><em>string</em></a>) &#8211; path to source file to stage from.
The tgt path is not an URL, but expected to be a path
relative to the shell&#8217;s URL.</li>
<li><strong>src</strong> (<a class="reference external" href="http://docs.python.org/library/string.html#module-string" title="(in Python v2.7)"><em>string</em></a>) &#8211; path of local target file to stage to.
The tgt path is not an URL, but expected to be a path
relative to the current working directory.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="saga.utils.pty_process.PTYProcess">
<em class="property">class </em><tt class="descclassname">saga.utils.pty_process.</tt><tt class="descname">PTYProcess</tt><big>(</big><em>command</em>, <em>logger=None</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_process.html#PTYProcess"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_process.PTYProcess" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <tt class="xref py py-class docutils literal"><span class="pre">object</span></tt></p>
<p>This class spawns a process, providing that child with pty I/O channels &#8211;
it will maintain stdin, stdout and stderr channels to the child.  All
write-like operations operate on the stdin, all read-like operations operate
on the stdout stream.  Data from the stderr stream are at this point
redirected to the stdout channel.</p>
<p>Example:</p>
<div class="highlight-python"><pre># run an interactive client process
pty = PTYProcess ("/usr/bin/ssh -t localhost")

# check client's I/O for one of the following patterns (prompts).  
# Then search again.
n, match = pty.find (['password\s*:\s*$', 
                      'want to continue connecting.*\(yes/no\)\s*$', 
                      '[\$#&gt;]\s*$'])

while True :

    if n == 0 :
        # found password prompt - tell the secret
        pty.write ("secret\n")
        n, _ = pty.find (['password\s*:\s*$', 
                          'want to continue connecting.*\(yes/no\)\s*$', 
                          '[\$#&gt;]\s*$'])
    elif n == 1 :
        # found request to accept host key - sure we do... (who checks
        # those keys anyways...?).  Then search again.
        pty.write ("yes\n")
        n, _ = pty.find (['password\s*:\s*$', 
                          'want to continue connecting.*\(yes/no\)\s*$', 
                          '[\$#&gt;]\s*$'])
    elif n == 2 :
        # found shell prompt!  Wohoo!
        break


while True :
    # go full Dornroeschen (Sleeping Beauty)...
    pty.alive (recover=True) or break      # check / restart process
    pty.find  (['[\$#&gt;]\s*$'])             # find shell prompt
    pty.write ("/bin/sleep "100 years"\n") # sleep!  SLEEEP!

# something bad happened
print pty.autopsy ()</pre>
</div>
<dl class="method">
<dt id="saga.utils.pty_process.PTYProcess.initialize">
<tt class="descname">initialize</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_process.html#PTYProcess.initialize"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_process.PTYProcess.initialize" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="saga.utils.pty_process.PTYProcess.finalize">
<tt class="descname">finalize</tt><big>(</big><em>wstat=None</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_process.html#PTYProcess.finalize"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_process.PTYProcess.finalize" title="Permalink to this definition">¶</a></dt>
<dd><p>kill the child, close all I/O channels</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_process.PTYProcess.wait">
<tt class="descname">wait</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_process.html#PTYProcess.wait"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_process.PTYProcess.wait" title="Permalink to this definition">¶</a></dt>
<dd><p>blocks forever until the child finishes on its own, or is getting
killed.</p>
<p>Actully, we might just as well try to figure out what is going on on the
remote end of things &#8211; so we read the pipe until the child dies...</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_process.PTYProcess.alive">
<tt class="descname">alive</tt><big>(</big><em>recover=False</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_process.html#PTYProcess.alive"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_process.PTYProcess.alive" title="Permalink to this definition">¶</a></dt>
<dd><p>try to determine if the child process is still active.  If not, mark 
the child as dead and close all IO descriptors etc (&#8220;func:<cite>finalize</cite>).</p>
<p>If <cite>recover</cite> is <cite>True</cite> and the child is indeed dead, we attempt to
re-initialize it (<tt class="xref py py-func docutils literal"><span class="pre">initialize()</span></tt>).  We only do that for so many
times (<cite>self.recover_max</cite>) before giving up &#8211; at that point it seems
likely that the child exits due to a re-occurring operations condition.</p>
<p>Note that upstream consumers of the <tt class="xref py py-class docutils literal"><span class="pre">PTYProcess</span></tt> should be
careful to only use <cite>recover=True</cite> when they can indeed handle
a disconnected/reconnected client at that point, i.e. if there are no
assumptions on persistent state beyond those in control of the upstream
consumers themselves.</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_process.PTYProcess.autopsy">
<tt class="descname">autopsy</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_process.html#PTYProcess.autopsy"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_process.PTYProcess.autopsy" title="Permalink to this definition">¶</a></dt>
<dd><p>return diagnostics information string for dead child processes</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_process.PTYProcess.read">
<tt class="descname">read</tt><big>(</big><em>size=0</em>, <em>timeout=0</em>, <em>_force=False</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_process.html#PTYProcess.read"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_process.PTYProcess.read" title="Permalink to this definition">¶</a></dt>
<dd><p>read some data from the child.  By default, the method reads whatever is
available on the next read, up to _CHUNKSIZE, but other read sizes can
be specified.</p>
<p>The method will return whatever data it has at timeout:</p>
<div class="highlight-python"><pre>timeout == 0 : return the content of the first successful read, with
               whatever data up to 'size' have been found.
timeout &lt;  0 : return after first read attempt, even if no data have 
               been available.</pre>
</div>
<p>If no data are found, the method returns an empty string (not None).</p>
<p>This method will not fill the cache, but will just read whatever data it
needs (FIXME).</p>
<p>Note: the returned lines do <em>not</em> get &#8216;\r&#8217; stripped.</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_process.PTYProcess.find">
<tt class="descname">find</tt><big>(</big><em>patterns</em>, <em>timeout=0</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_process.html#PTYProcess.find"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_process.PTYProcess.find" title="Permalink to this definition">¶</a></dt>
<dd><p>This methods reads bytes from the child process until a string matching
any of the given patterns is found.  If that is found, all read data are
returned as a string, up to (and including) the match.  Note that
pattern can match an empty string, and the call then will return just
that, an empty string.  If all patterns end with matching a newline,
this method is effectively matching lines &#8211; but note that &#8216;$&#8217; will also
match the end of the (currently available) data stream.</p>
<p>The call actually returns a tuple, containing the index of the matching
pattern, and the string up to the match as described above.</p>
<p>If no pattern is found before timeout, the call returns (None, None).
Negative timeouts will block until a match is found</p>
<p>Note that the pattern are interpreted with the re.M (multi-line) and
re.S (dot matches all) regex flags.</p>
<p>Performance: the call is doing repeated string regex searches over
whatever data it finds.  On complex regexes, and large data, and small
read buffers, this method can be expensive.</p>
<p>Note: the returned data get &#8216;\r&#8217; stripped.</p>
</dd></dl>

<dl class="method">
<dt id="saga.utils.pty_process.PTYProcess.write">
<tt class="descname">write</tt><big>(</big><em>data</em><big>)</big><a class="reference internal" href="../_modules/saga/utils/pty_process.html#PTYProcess.write"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#saga.utils.pty_process.PTYProcess.write" title="Permalink to this definition">¶</a></dt>
<dd><p>This method will repeatedly attempt to push the given data into the
child&#8217;s stdin pipe, until it succeeds to write all data.</p>
</dd></dl>

</dd></dl>

</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">1. Writing SAGA-Python Adaptors</a><ul>
<li><a class="reference internal" href="#adaptor-structure">1.1. Adaptor Structure</a></li>
<li><a class="reference internal" href="#adaptor-registration">1.2. Adaptor Registration</a></li>
<li><a class="reference internal" href="#adaptor-binding">1.3. Adaptor Binding</a></li>
<li><a class="reference internal" href="#adaptor-state">1.4. Adaptor State</a></li>
<li><a class="reference internal" href="#creating-api-objects">1.5. Creating API Objects</a></li>
<li><a class="reference internal" href="#exception-handling">1.6. Exception Handling</a></li>
<li><a class="reference internal" href="#asynchronous-methods">1.7. Asynchronous Methods</a></li>
<li><a class="reference internal" href="#bulk-operations">1.8. Bulk Operations:</a></li>
<li><a class="reference internal" href="#adaptor-logging">1.9. Adaptor Logging</a></li>
<li><a class="reference internal" href="#external-processes">1.10. External Processes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">5. Developer Documentation</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/developers/adaptorwriting.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="index.html" title="5. Developer Documentation"
             >previous</a> |</li>
        <li><a href="../index.html">SAGA 0.9.13 documentation</a> &raquo;</li>
          <li><a href="index.html" >5. Developer Documentation</a> &raquo;</li> 
      </ul>
    </div>
<div class="footer">
    &copy; Copyright 2012, The SAGA Project.
  Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2b3.
  <br />Theme based on <a href="http://readthedocs.org/">Read The Docs</a>

</div>





  </body>
</html>
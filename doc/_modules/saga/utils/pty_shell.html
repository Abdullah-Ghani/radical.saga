
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    

    <title>saga.utils.pty_shell &mdash; SAGA 0.1.1-85-g8db36a4 documentation</title>

<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>


    
    <link rel="stylesheet" href="../../../_static/rtd.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1.1-85-g8db36a4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../../../_static/searchtools.js"></script>
    <link rel="top" title="SAGA 0.1.1-85-g8db36a4 documentation" href="../../../index.html" />
    <link rel="up" title="saga" href="../../saga.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">SAGA 0.1.1-85-g8db36a4 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../saga.html" accesskey="U">saga</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for saga.utils.pty_shell</h1><div class="highlight"><pre>
<span class="n">__author__</span>    <span class="o">=</span> <span class="s">&quot;Andre Merzky&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s">&quot;Copyright 2012-2013, The SAGA Project&quot;</span>
<span class="n">__license__</span>   <span class="o">=</span> <span class="s">&quot;MIT&quot;</span>


<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">errno</span>

<span class="kn">import</span> <span class="nn">saga.utils.logger</span>            <span class="kn">as</span> <span class="nn">sul</span>
<span class="kn">import</span> <span class="nn">saga.utils.pty_shell_factory</span> <span class="kn">as</span> <span class="nn">supsf</span>
<span class="kn">import</span> <span class="nn">saga.exceptions</span>              <span class="kn">as</span> <span class="nn">se</span>
<span class="kn">import</span> <span class="nn">saga.session</span>                 <span class="kn">as</span> <span class="nn">ss</span>

<span class="n">_PTY_TIMEOUT</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="c"># ------------------------------------------------------------------------------</span>
<span class="c">#</span>
<span class="c"># iomode flags</span>
<span class="c">#</span>
<span class="n">IGNORE</span>   <span class="o">=</span> <span class="mi">0</span>    <span class="c"># discard stdout / stderr</span>
<span class="n">MERGED</span>   <span class="o">=</span> <span class="mi">1</span>    <span class="c"># merge stdout and stderr</span>
<span class="n">SEPARATE</span> <span class="o">=</span> <span class="mi">2</span>    <span class="c"># fetch stdout and stderr individually (one more hop)</span>
<span class="n">STDOUT</span>   <span class="o">=</span> <span class="mi">3</span>    <span class="c"># fetch stdout only, discard stderr</span>
<span class="n">STDERR</span>   <span class="o">=</span> <span class="mi">4</span>    <span class="c"># fetch stderr only, discard stdout</span>


<span class="c"># --------------------------------------------------------------------</span>
<span class="c">#</span>
<span class="k">class</span> <span class="nc">PTYShell</span> <span class="p">(</span><span class="nb">object</span><span class="p">)</span> <span class="p">:</span>
<div class="viewcode-block" id="PTYShell"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class wraps a shell process and runs it as a :class:`PTYProcess`.  The</span>
<span class="sd">    user of this class can start that shell, and run arbitrary commands on it.</span>

<span class="sd">    The shell to be run is expected to be POSIX compliant (bash, dash, sh, ksh</span>
<span class="sd">    etc.) -- in particular, we expect the following features:</span>
<span class="sd">    ``$?``,</span>
<span class="sd">    ``$!``,</span>
<span class="sd">    ``$#``,</span>
<span class="sd">    ``$*``,</span>
<span class="sd">    ``$@``,</span>
<span class="sd">    ``$$``,</span>
<span class="sd">    ``$PPID``,</span>
<span class="sd">    ``&gt;&amp;``,</span>
<span class="sd">    ``&gt;&gt;``,</span>
<span class="sd">    ``&gt;``,</span>
<span class="sd">    ``&lt;``,</span>
<span class="sd">    ``|``,</span>
<span class="sd">    ``||``,</span>
<span class="sd">    ``()``,</span>
<span class="sd">    ``&amp;``,</span>
<span class="sd">    ``&amp;&amp;``,</span>
<span class="sd">    ``wait``,</span>
<span class="sd">    ``kill``,</span>
<span class="sd">    ``nohup``,</span>
<span class="sd">    ``shift``,</span>
<span class="sd">    ``export``,</span>
<span class="sd">    ``PS1``, and</span>
<span class="sd">    ``PS2``.</span>

<span class="sd">    Note that ``PTYShell`` will change the shell prompts (``PS1`` and ``PS2``),</span>
<span class="sd">    to simplify output parsing.  ``PS2`` will be empty, ``PS1`` will be set</span>
<span class="sd">    ``PROMPT-$?-&gt;`` -- that way, the prompt will report the exit value of the</span>
<span class="sd">    last command, saving an extra roundtrip.  Users of this class should be</span>
<span class="sd">    careful when setting other prompts -- see :func:`set_prompt` for more</span>
<span class="sd">    details.</span>

<span class="sd">    Usage Example::</span>

<span class="sd">        # start the shell, find its prompt.  </span>
<span class="sd">        self.shell = saga.utils.pty_shell.PTYShell (&quot;ssh://user@remote.host.net/&quot;, contexts, self._logger)</span>

<span class="sd">        # run a simple shell command, merge stderr with stdout.  $$ is the pid</span>
<span class="sd">        # of the shell instance.</span>
<span class="sd">        ret, out, _ = self.shell.run_sync (&quot;mkdir -p /tmp/data.$$/&quot; )</span>

<span class="sd">        # check if mkdir reported success</span>
<span class="sd">        if  ret != 0 :</span>
<span class="sd">            raise saga.NoSuccess (&quot;failed to prepare base dir (%s)(%s)&quot; % (ret, out))</span>

<span class="sd">        # stage some data from a local string variable into a file on the remote system</span>
<span class="sd">        self.shell.stage_to_remote (src = pbs_job_script, </span>
<span class="sd">                                    tgt = &quot;/tmp/data.$$/job_1.pbs&quot;)</span>

<span class="sd">        # check size of staged script (this is actually done on PTYShell level</span>
<span class="sd">        # already, with no extra hop):</span>
<span class="sd">        ret, out, _ = self.shell.run_sync (&quot;stat -c &#39;%s&#39; /tmp/data.$$/job_1.pbs&quot; )</span>
<span class="sd">        if  ret != 0 :</span>
<span class="sd">            raise saga.NoSuccess (&quot;failed to check size (%s)(%s)&quot; % (ret, out))</span>

<span class="sd">        assert (len(pbs_job_script) == int(out))</span>


<span class="sd">    **Data Staging and Data Management:**</span>
<span class="sd">    </span>

<span class="sd">    The PTYShell class does not only support command execution, but also basic</span>
<span class="sd">    data management: for SSH based shells, it will create a tunneled scp/sftp</span>
<span class="sd">    connection for file staging.  Other data management operations (mkdir, size,</span>
<span class="sd">    list, ...) are executed either as shell commands, or on the scp/sftp channel</span>
<span class="sd">    (if possible on the data channel, to keep the shell pty free for concurrent</span>
<span class="sd">    command execution).  Ssh tunneling is implemented via ssh.v2 &#39;ControlMaster&#39;</span>
<span class="sd">    capabilities (see `ssh_config(5)`).</span>
<span class="sd">    </span>
<span class="sd">    For local shells, PTYShell will create an additional shell pty for data</span>
<span class="sd">    management operations.  </span>


<span class="sd">    **Asynchronous Notifications:**</span>

<span class="sd">    A third pty process will be created for asynchronous notifications.  For</span>
<span class="sd">    that purpose, the shell started on the first channel will create a named</span>
<span class="sd">    pipe, at::</span>

<span class="sd">      $HOME/.saga/adaptors/shell/async.$$</span>

<span class="sd">    ``$$`` here represents the pid of the shell process.  It will also set the</span>
<span class="sd">    environment variable ``SAGA_ASYNC_PIPE`` to point to that named pipe -- any</span>
<span class="sd">    application running on the remote host can write event messages to that</span>
<span class="sd">    pipe, which will be available on the local end (see below).  `PTYShell`</span>
<span class="sd">    leaves it unspecified what format those messages have, but messages are</span>
<span class="sd">    expected to be separated by newlines.</span>
<span class="sd">    </span>
<span class="sd">    An adaptor using `PTYShell` can subscribe for messages via::</span>

<span class="sd">      self.pty_shell.subscribe (callback)</span>

<span class="sd">    where callback is a Python callable.  PTYShell will listen on the event</span>
<span class="sd">    channel *in a separate thread* and invoke that callback on any received</span>
<span class="sd">    message, passing the message text (sans newline) to the callback.</span>

<span class="sd">    An example usage: the command channel may run the following command line::</span>

<span class="sd">      ( sh -c &#39;sleep 100 &amp;&amp; echo &quot;job $$ done&quot; &gt; $SAGA_ASYNC_PIPE&quot; \</span>
<span class="sd">                         || echo &quot;job $$ fail&quot; &gt; $SAGA_ASYNC_PIPE&quot; ) &amp;</span>

<span class="sd">    which will return immediately, and send a notification message at job</span>
<span class="sd">    completion.</span>

<span class="sd">    Note that writes to named pipes are not atomic.  From POSIX:</span>

<span class="sd">    ``A write is atomic if the whole amount written in one operation is not</span>
<span class="sd">    interleaved with data from any other process. This is useful when there are</span>
<span class="sd">    multiple writers sending data to a single reader. Applications need to know</span>
<span class="sd">    how large a write request can be expected to be performed atomically. This</span>
<span class="sd">    maximum is called {PIPE_BUF}. This volume of IEEE Std 1003.1-2001 does not</span>
<span class="sd">    say whether write requests for more than {PIPE_BUF} bytes are atomic, but</span>
<span class="sd">    requires that writes of {PIPE_BUF} or fewer bytes shall be atomic.`</span>

<span class="sd">    Thus the user is responsible for ensuring that either messages are smaller</span>
<span class="sd">    than *PIPE_BUF* bytes on the remote system (usually at least 1024, on Linux</span>
<span class="sd">    usually 4096), or to lock the pipe on larger writes.</span>


<span class="sd">    **Automated Restart, Timeouts:**</span>

<span class="sd">    For timeout and restart semantics, please see the documentation to the</span>
<span class="sd">    underlying :class:`saga.utils.pty_process.PTYProcess` class.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># TODO: </span>
    <span class="c">#   - on client shell activitites, also mark the master as active, to</span>
    <span class="c">#     avoid timeout garbage collection.</span>
    <span class="c">#   - use ssh mechanisms for master timeout (and persist), as custom</span>
    <span class="c">#     mechanisms will interfere with gc_timout.</span>

    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="p">{})</span> <span class="p">:</span>

        <span class="k">if</span>  <span class="bp">None</span> <span class="o">!=</span> <span class="n">logger</span>  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>  <span class="o">=</span> <span class="n">logger</span>
        <span class="k">else</span>                <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>  <span class="o">=</span> <span class="n">sul</span><span class="o">.</span><span class="n">getLogger</span> <span class="p">(</span><span class="s">&#39;PTYShell&#39;</span><span class="p">)</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s">&quot;PTYShell init </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">url</span>         <span class="o">=</span> <span class="n">url</span>      <span class="c"># describes the shell to run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span>        <span class="o">=</span> <span class="n">init</span>     <span class="c"># call after reconnect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span>        <span class="o">=</span> <span class="n">opts</span>     <span class="c"># options...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latency</span>     <span class="o">=</span> <span class="mf">0.0</span>      <span class="c"># set by factory</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span>      <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_re</span>   <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># we need a local dir for file staging caches.  At this point we use</span>
        <span class="c"># $HOME, but should make this configurable (FIXME)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;HOME&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;/.saga/adaptors/shell/&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;could not create staging dir: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        
        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span>    <span class="o">=</span> <span class="n">supsf</span><span class="o">.</span><span class="n">PTYShellFactory</span>   <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pty_info</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">initialize</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">run_shell</span>  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pty_info</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span> <span class="p">()</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">__del__</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s">&quot;PTYShell del  </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span> <span class="p">(</span><span class="n">kill_pty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">initialize</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
<div class="viewcode-block" id="PTYShell.initialize"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.initialize">[docs]</a>        <span class="sd">&quot;&quot;&quot; initialize the shell connection.  &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">rlock</span> <span class="p">:</span>

            <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span> <span class="p">(</span><span class="s">&quot;initialization race&quot;</span><span class="p">)</span>
                <span class="k">return</span>


            <span class="c"># run a POSIX compatible shell, usually /bin/sh, in interactive mode</span>
            <span class="c"># also, turn off tty echo</span>
            <span class="n">command_shell</span> <span class="o">=</span> <span class="s">&quot;exec /bin/sh -i&quot;</span>

            <span class="c"># use custom shell if so requested</span>
            <span class="k">if</span>  <span class="s">&#39;shell&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;shell&#39;</span><span class="p">]</span> <span class="p">:</span>
                <span class="n">command_shell</span> <span class="o">=</span> <span class="s">&quot;exec </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;shell&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="p">(</span><span class="s">&quot;custom  command shell: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">command_shell</span><span class="p">)</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span>    <span class="p">(</span><span class="s">&quot;running command shell: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">command_shell</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s">&quot;stty -echo ; </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span>         <span class="o">%</span> <span class="n">command_shell</span><span class="p">)</span>

            <span class="c"># make sure this worked, and that we find the prompt. We use</span>
            <span class="c"># a versatile prompt pattern to account for the custom shell case.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find</span> <span class="p">([</span><span class="s">&quot;^(.*[\$#%&gt;])\s*$&quot;</span><span class="p">])</span>

            <span class="c"># make sure this worked, and that we find the prompt. We use</span>
            <span class="c"># a versatile prompt pattern to account for the custom shell case.</span>
            <span class="k">try</span> <span class="p">:</span>
                <span class="c"># set and register new prompt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_async</span>  <span class="p">(</span><span class="s">&quot;unset PROMPT_COMMAND ; &quot;</span>
                                     <span class="o">+</span> <span class="s">&quot;PS1=&#39;PROMPT-$?-&gt;&#39;; &quot;</span>
                                     <span class="o">+</span> <span class="s">&quot;PS2=&#39;&#39;; &quot;</span>
                                     <span class="o">+</span> <span class="s">&quot;export PS1 PS2 2&gt;&amp;1 &gt;/dev/null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_prompt</span> <span class="p">(</span><span class="n">new_prompt</span><span class="o">=</span><span class="s">&quot;PROMPT-(\d+)-&gt;$&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s">&quot;got new shell prompt&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;Shell startup on target host failed: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="bp">True</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">finalize</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kill_pty</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.finalize"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.finalize">[docs]</a>
        <span class="k">try</span> <span class="p">:</span>
            <span class="k">if</span>  <span class="n">kill_pty</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span> <span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">rlock</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">finalize</span> <span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
            <span class="k">pass</span>



    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">alive</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recover</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.alive"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.alive">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The shell is assumed to be alive if the shell processes lives.</span>
<span class="sd">        Attempt to restart shell if recover==True</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">rlock</span> <span class="p">:</span>

            <span class="k">try</span> <span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">alive</span> <span class="p">(</span><span class="n">recover</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_exception</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">find_prompt</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.find_prompt"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.find_prompt">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If run_async was called, a command is running on the shell.  find_prompt</span>
<span class="sd">        can be used to collect its output up to the point where the shell prompt</span>
<span class="sd">        re-appears (i.e. when the command finishes).</span>


<span class="sd">        Note that this method blocks until the command finishes.  Future</span>
<span class="sd">        versions of this call may add a timeout parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">rlock</span> <span class="p">:</span>

            <span class="k">try</span> <span class="p">:</span>

                <span class="n">match</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">fret</span>  <span class="o">=</span> <span class="bp">None</span>

                <span class="k">while</span> <span class="n">fret</span> <span class="o">==</span> <span class="bp">None</span> <span class="p">:</span>
                    <span class="n">fret</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">find</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">],</span> <span class="n">_PTY_TIMEOUT</span><span class="p">)</span>
                
              <span class="c"># self.logger.debug  (&quot;find prompt &#39;%s&#39; in &#39;%s&#39;&quot; % (self.prompt, match))</span>
                <span class="n">ret</span><span class="p">,</span> <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_prompt</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span>

                <span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_exception</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">find</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.find"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.find">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note that this method blocks until pattern is found in the shell I/O.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">rlock</span> <span class="p">:</span>

            <span class="k">try</span> <span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">find</span> <span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_exception</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">set_prompt</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_prompt</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.set_prompt"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.set_prompt">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :type  new_prompt:  string </span>
<span class="sd">        :param new_prompt:  a regular expression matching the shell prompt</span>

<span class="sd">        The new_prompt regex is expected to be a regular expression with one set</span>
<span class="sd">        of catching brackets, which MUST return the previous command&#39;s exit</span>
<span class="sd">        status.  This method will send a newline to the client, and expects to</span>
<span class="sd">        find the prompt with the exit value &#39;0&#39;.</span>

<span class="sd">        As a side effect, this method will discard all previous data on the pty,</span>
<span class="sd">        thus effectively flushing the pty output.  </span>

<span class="sd">        By encoding the exit value in the command prompt, we safe one roundtrip.</span>
<span class="sd">        The prompt on Posix compliant shells can be set, for example, via::</span>

<span class="sd">          PS1=&#39;PROMPT-$?-&gt;&#39;; export PS1</span>

<span class="sd">        The newline in the example above allows to nicely anchor the regular</span>
<span class="sd">        expression, which would look like::</span>

<span class="sd">          PROMPT-(\d+)-&gt;$</span>

<span class="sd">        The regex is compiled with &#39;re.DOTALL&#39;, so the dot character matches</span>
<span class="sd">        all characters, including line breaks.  Be careful not to match more</span>
<span class="sd">        than the exact prompt -- otherwise, a prompt search will swallow stdout</span>
<span class="sd">        data.  For example, the following regex::</span>

<span class="sd">          PROMPT-(.+)-&gt;$</span>

<span class="sd">        would capture arbitrary strings, and would thus match *all* of::</span>

<span class="sd">          PROMPT-0-&gt;ls</span>
<span class="sd">          data/ info</span>
<span class="sd">          PROMPT-0-&gt;</span>

<span class="sd">        and thus swallow the ls output...</span>

<span class="sd">        Note that the string match *before* the prompt regex is non-gready -- if</span>
<span class="sd">        the output contains multiple occurrences of the prompt, only the match</span>
<span class="sd">        up to the first occurence is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">rlock</span> <span class="p">:</span>

            <span class="n">old_prompt</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span>    <span class="o">=</span> <span class="n">new_prompt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prompt_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span> <span class="p">(</span><span class="s">&quot;^(.*?)</span><span class="si">%s</span><span class="s">\s*$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>

            <span class="n">retries</span>  <span class="o">=</span> <span class="mi">0</span>
            <span class="n">triggers</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">while</span> <span class="bp">True</span> <span class="p">:</span>

                <span class="k">try</span> <span class="p">:</span>
                    <span class="c"># make sure we have a non-zero waiting delay (default to</span>
                    <span class="c"># 1 second)</span>
                    <span class="n">delay</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">latency</span>
                    <span class="k">if</span>  <span class="ow">not</span> <span class="n">delay</span> <span class="p">:</span>
                        <span class="n">delay</span> <span class="o">=</span> <span class="mf">1.0</span>

                    <span class="c"># FIXME: how do we know that _PTY_TIMOUT suffices?  In particular if</span>
                    <span class="c"># we actually need to flush...</span>
                    <span class="n">fret</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">find</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">],</span> <span class="n">delay</span><span class="p">)</span>

                    <span class="k">if</span>  <span class="n">fret</span> <span class="o">==</span> <span class="bp">None</span> <span class="p">:</span>
                    
                        <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span>  <span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">old_prompt</span>
                            <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">BadParameter</span> <span class="p">(</span><span class="s">&quot;Cannot use new prompt, parsing failed (10 retries)&quot;</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span>  <span class="p">(</span><span class="s">&quot;sent prompt trigger again (</span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">retries</span><span class="p">)</span>
                        <span class="n">triggers</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>


                    <span class="c"># found a match -- lets see if this is working now...</span>
                    <span class="n">ret</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_prompt</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span>

                    <span class="k">if</span>  <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">old_prompt</span>
                        <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">BadParameter</span> <span class="p">(</span><span class="s">&quot;could not parse exit value (</span><span class="si">%s</span><span class="s">)&quot;</span> \
                                            <span class="o">%</span> <span class="n">match</span><span class="p">)</span>

                    <span class="c"># prompt looks valid...</span>
                    <span class="k">break</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">old_prompt</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_exception</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s">&quot;Could not set shell prompt&quot;</span><span class="p">)</span>


            <span class="c"># got a valid prompt -- but we have to sync the output again in</span>
            <span class="c"># those cases where we had to use triggers to actually get the</span>
            <span class="c"># prompt</span>
            <span class="k">if</span> <span class="n">triggers</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_async</span> <span class="p">(</span><span class="s">&#39;printf &quot;SYNCHRONIZE_PROMPT</span><span class="se">\n</span><span class="s">&quot;&#39;</span><span class="p">)</span>

                <span class="c"># FIXME: better timout value?</span>
                <span class="n">fret</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">find</span> <span class="p">([</span><span class="s">&quot;SYNCHRONIZE_PROMPT&quot;</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>  

                <span class="k">if</span>  <span class="n">fret</span> <span class="o">==</span> <span class="bp">None</span> <span class="p">:</span>
                    <span class="c"># not find prompt after blocking?  BAD!  Restart the shell</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span> <span class="p">(</span><span class="n">kill_pty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;Could not synchronize prompt detection&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">find_prompt</span> <span class="p">()</span>



    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">_eval_prompt</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">new_prompt</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="p">:</span></div>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will match the given data against the current prompt regex,</span>
<span class="sd">        and expects to find an integer as match -- which is then returned, along</span>
<span class="sd">        with all leading data, in a tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">rlock</span> <span class="p">:</span>

            <span class="k">try</span> <span class="p">:</span>

                <span class="n">prompt</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span>
                <span class="n">prompt_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_re</span>

                <span class="k">if</span>  <span class="n">new_prompt</span> <span class="p">:</span>
                    <span class="n">prompt</span>    <span class="o">=</span> <span class="n">new_prompt</span>
                    <span class="n">prompt_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span> <span class="p">(</span><span class="s">&quot;^(.*)</span><span class="si">%s</span><span class="s">\s*$&quot;</span> <span class="o">%</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>


                <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span>  <span class="ow">not</span> <span class="n">data</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;cannot not parse prompt (</span><span class="si">%s</span><span class="s">), invalid data (</span><span class="si">%s</span><span class="s">)&quot;</span> \
                                     <span class="o">%</span> <span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">prompt_re</span><span class="o">.</span><span class="n">match</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>

                <span class="k">if</span>  <span class="ow">not</span> <span class="n">result</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span>  <span class="p">(</span><span class="s">&quot;could not parse prompt (</span><span class="si">%s</span><span class="s">) (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;could not parse prompt (</span><span class="si">%s</span><span class="s">) (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

                <span class="k">if</span>  <span class="nb">len</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">groups</span> <span class="p">())</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span>  <span class="p">(</span><span class="s">&quot;prompt does not capture exit value (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">prompt</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;prompt does not capture exit value (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">prompt</span><span class="p">)</span>

                <span class="n">txt</span> <span class="o">=</span>     <span class="n">result</span><span class="o">.</span><span class="n">group</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">group</span> <span class="p">(</span><span class="mi">2</span><span class="p">))</span> 

                <span class="c"># if that worked, we can permanently set new_prompt</span>
                <span class="k">if</span>  <span class="n">new_prompt</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_prompt</span> <span class="p">(</span><span class="n">new_prompt</span><span class="p">)</span>

                <span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
                
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_exception</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s">&quot;Could not eval prompt&quot;</span><span class="p">)</span>




    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">run_sync</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">iomode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">new_prompt</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="p">:</span>
<div class="viewcode-block" id="PTYShell.run_sync"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.run_sync">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a shell command, and report exit code, stdout and stderr (all three</span>
<span class="sd">        will be returned in a tuple).  The call will block until the command</span>
<span class="sd">        finishes (more exactly, until we find the prompt again on the shell&#39;s</span>
<span class="sd">        I/O stream), and cannot be interrupted.</span>

<span class="sd">        :type  command: string</span>
<span class="sd">        :param command: shell command to run.  </span>
<span class="sd">        </span>
<span class="sd">        :type  iomode:  enum</span>
<span class="sd">        :param iomode:  Defines how stdout and stderr are captured.  </span>

<span class="sd">        :type  new_prompt:  string </span>
<span class="sd">        :param new_prompt:  regular expression matching the prompt after</span>
<span class="sd">        command succeeded.</span>

<span class="sd">        We expect the ``command`` to not to do stdio redirection, as this is we want</span>
<span class="sd">        to capture that separately.  We *do* allow pipes and stdin/stdout</span>
<span class="sd">        redirection.  Note that SEPARATE mode will break if the job is run in</span>
<span class="sd">        the background</span>

<span class="sd">        </span>
<span class="sd">        The following iomode values are valid:</span>

<span class="sd">          * *IGNORE:*   both stdout and stderr are discarded, `None` will be</span>
<span class="sd">                        returned for each.</span>
<span class="sd">          * *MERGED:*   both streams will be merged and returned as stdout; </span>
<span class="sd">                        stderr will be `None`.  This is the default.</span>
<span class="sd">          * *SEPARATE:* stdout and stderr will be captured separately, and</span>
<span class="sd">                        returned individually.  Note that this will require </span>
<span class="sd">                        at least one more network hop!  </span>
<span class="sd">          * *STDOUT:*   only stdout is captured, stderr will be `None`.</span>
<span class="sd">          * *STDERR:*   only stderr is captured, stdout will be `None`.</span>
<span class="sd">          * *None:*     do not perform any redirection -- this is effectively</span>
<span class="sd">                        the same as `MERGED`</span>

<span class="sd">        If any of the requested output streams does not return any data, an</span>
<span class="sd">        empty string is returned.</span>

<span class="sd">        </span>
<span class="sd">        If the command to be run changes the prompt to be expected for the</span>
<span class="sd">        shell, the ``new_prompt`` parameter MUST contain a regex to match the</span>
<span class="sd">        new prompt.  The same conventions as for set_prompt() hold -- i.e. we</span>
<span class="sd">        expect the prompt regex to capture the exit status of the process.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">rlock</span> <span class="p">:</span>

            <span class="c"># we expect the shell to be in &#39;ground state&#39; when running a syncronous</span>
            <span class="c"># command -- thus we can check if the shell is alive before doing so,</span>
            <span class="c"># and restart if needed</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">alive</span> <span class="p">(</span><span class="n">recover</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">IncorrectState</span> <span class="p">(</span><span class="s">&quot;Can&#39;t run command -- shell died:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> \
                                      <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">autopsy</span> <span class="p">())</span>

            <span class="k">try</span> <span class="p">:</span>

                <span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">strip</span> <span class="p">()</span>
                <span class="k">if</span> <span class="n">command</span><span class="o">.</span><span class="n">endswith</span> <span class="p">(</span><span class="s">&#39;&amp;&#39;</span><span class="p">)</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">BadParameter</span> <span class="p">(</span><span class="s">&quot;run_sync can only run foreground jobs (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> \
                                        <span class="o">%</span> <span class="n">command</span><span class="p">)</span>

                <span class="n">redir</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">_err</span>  <span class="o">=</span> <span class="s">&quot;/tmp/saga-python.ssh-job.stderr.$$&quot;</span>

                <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">IGNORE</span> <span class="p">:</span>
                    <span class="n">redir</span>  <span class="o">=</span>  <span class="s">&quot; 1&gt;&gt;/dev/null 2&gt;&gt;/dev/null&quot;</span>

                <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">MERGED</span> <span class="p">:</span>
                    <span class="n">redir</span>  <span class="o">=</span>  <span class="s">&quot; 2&gt;&amp;1&quot;</span>

                <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">SEPARATE</span> <span class="p">:</span>
                    <span class="n">redir</span>  <span class="o">=</span>  <span class="s">&quot; 2&gt;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_err</span>

                <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">STDOUT</span> <span class="p">:</span>
                    <span class="n">redir</span>  <span class="o">=</span>  <span class="s">&quot; 2&gt;/dev/null&quot;</span>

                <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">STDERR</span> <span class="p">:</span>
                    <span class="n">redir</span>  <span class="o">=</span>  <span class="s">&quot; 2&gt;&amp;1 1&gt;/dev/null&quot;</span>

                <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="bp">None</span> <span class="p">:</span>
                    <span class="n">redir</span>  <span class="o">=</span>  <span class="s">&quot;&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span>    <span class="p">(</span><span class="s">&#39;run_sync: </span><span class="si">%s%s</span><span class="s">&#39;</span>   <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">redir</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span>          <span class="s">&quot;</span><span class="si">%s%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">redir</span><span class="p">))</span>


                <span class="c"># If given, switch to new prompt pattern right now...</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span>
                <span class="k">if</span>  <span class="n">new_prompt</span> <span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">=</span> <span class="n">new_prompt</span>

                <span class="c"># command has been started - now find prompt again.  </span>
                <span class="n">fret</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">find</span> <span class="p">([</span><span class="n">prompt</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c"># blocks</span>

                <span class="k">if</span>  <span class="n">fret</span> <span class="o">==</span> <span class="bp">None</span> <span class="p">:</span>
                    <span class="c"># not find prompt after blocking?  BAD!  Restart the shell</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span> <span class="p">(</span><span class="n">kill_pty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">IncorrectState</span> <span class="p">(</span><span class="s">&quot;run_sync failed, no prompt (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>


                <span class="n">ret</span><span class="p">,</span> <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_prompt</span> <span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">new_prompt</span><span class="p">)</span>

                <span class="n">stdout</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">stderr</span> <span class="o">=</span> <span class="bp">None</span>

                <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">IGNORE</span> <span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">MERGED</span> <span class="p">:</span>
                    <span class="n">stdout</span> <span class="o">=</span>  <span class="n">txt</span>

                <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">SEPARATE</span> <span class="p">:</span>
                    <span class="n">stdout</span> <span class="o">=</span>  <span class="n">txt</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s">&quot;cat </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_err</span><span class="p">)</span>
                    <span class="n">fret</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">find</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c"># blocks</span>

                    <span class="k">if</span>  <span class="n">fret</span> <span class="o">==</span> <span class="bp">None</span> <span class="p">:</span>
                        <span class="c"># not find prompt after blocking?  BAD!  Restart the shell</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span> <span class="p">(</span><span class="n">kill_pty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">IncorrectState</span> <span class="p">(</span><span class="s">&quot;run_sync failed, no prompt (</span><span class="si">%s</span><span class="s">)&quot;</span> \
                                              <span class="o">%</span> <span class="n">command</span><span class="p">)</span>

                    <span class="n">_ret</span><span class="p">,</span> <span class="n">_stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_prompt</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span>
                    <span class="k">if</span>  <span class="n">_ret</span> <span class="p">:</span>
                        <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">IncorrectState</span> <span class="p">(</span><span class="s">&quot;run_sync failed, no stderr (</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">)&quot;</span> \
                                              <span class="o">%</span> <span class="p">(</span><span class="n">_ret</span><span class="p">,</span> <span class="n">_stderr</span><span class="p">))</span>
                    <span class="n">stderr</span> <span class="o">=</span>  <span class="n">_stderr</span>


                <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">STDOUT</span> <span class="p">:</span>
                    <span class="n">stdout</span> <span class="o">=</span>  <span class="n">txt</span>

                <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">STDERR</span> <span class="p">:</span>
                    <span class="n">stderr</span> <span class="o">=</span>  <span class="n">txt</span>

                <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="bp">None</span> <span class="p">:</span>
                    <span class="n">stdout</span> <span class="o">=</span>  <span class="n">txt</span>

                <span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_exception</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">run_async</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.run_async"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.run_async">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a shell command, but don&#39;t wait for prompt -- just return.  It is up</span>
<span class="sd">        to caller to eventually search for the prompt again (see</span>
<span class="sd">        :func:`find_prompt`.  Meanwhile, the caller can interact with the called</span>
<span class="sd">        command, via the I/O channels.</span>

<span class="sd">        :type  command: string</span>
<span class="sd">        :param command: shell command to run.  </span>

<span class="sd">        For async execution, we don&#39;t care if the command is doing i/o redirection or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">rlock</span> <span class="p">:</span>

            <span class="c"># we expect the shell to be in &#39;ground state&#39; when running an asyncronous</span>
            <span class="c"># command -- thus we can check if the shell is alive before doing so,</span>
            <span class="c"># and restart if needed</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">alive</span> <span class="p">(</span><span class="n">recover</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">IncorrectState</span> <span class="p">(</span><span class="s">&quot;Cannot run command:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> \
                                      <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">autopsy</span> <span class="p">())</span>

            <span class="k">try</span> <span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">strip</span> <span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_exception</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">send</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.send"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.send">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send data to the shell.  No newline is appended!</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">rlock</span> <span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">alive</span> <span class="p">(</span><span class="n">recover</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">se</span><span class="o">.</span><span class="n">IncorrectState</span> <span class="p">(</span><span class="s">&quot;Cannot send data:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> \
                                      <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">autopsy</span> <span class="p">())</span>

            <span class="k">try</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pty_shell</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_exception</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">write_to_remote</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.write_to_remote"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.write_to_remote">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :type  src: string</span>
<span class="sd">        :param src: data to be staged into the target file</span>

<span class="sd">        :type  tgt: string</span>
<span class="sd">        :param tgt: path to target file to staged to</span>
<span class="sd">                    The tgt path is not an URL, but expected to be a path</span>
<span class="sd">                    relative to the shell&#39;s URL.</span>

<span class="sd">        The content of the given string is pasted into a file (specified by tgt)</span>
<span class="sd">        on the remote system.  If that file exists, it is overwritten.</span>
<span class="sd">        A NoSuccess exception is raised if writing the file was not possible</span>
<span class="sd">        (missing permissions, incorrect path, etc.).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span> <span class="p">:</span>

            <span class="c"># FIXME: make this relative to the shell&#39;s pwd?  Needs pwd in</span>
            <span class="c"># prompt, and updating pwd state on every find_prompt.</span>

            <span class="c"># first, write data into a tmp file</span>
            <span class="n">fname</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">+</span> <span class="s">&quot;/staging.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">fhandle</span> <span class="o">=</span> <span class="nb">open</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span>  <span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="n">fhandle</span><span class="o">.</span><span class="n">flush</span>  <span class="p">()</span>
            <span class="n">fhandle</span><span class="o">.</span><span class="n">close</span>  <span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">run_copy_to</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pty_info</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">tgt</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">remove</span> <span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_exception</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">read_from_remote</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.read_from_remote"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.read_from_remote">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :type  src: string</span>
<span class="sd">        :param src: path to source file to staged from</span>
<span class="sd">                    The src path is not an URL, but expected to be a path</span>
<span class="sd">                    relative to the shell&#39;s URL.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span> <span class="p">:</span>
            <span class="c"># FIXME: make this relative to the shell&#39;s pwd?  Needs pwd in</span>
            <span class="c"># prompt, and updating pwd state on every find_prompt.</span>

            <span class="c"># first, write data into a tmp file</span>
            <span class="n">fname</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">+</span> <span class="s">&quot;/staging.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">run_copy_from</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pty_info</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

            <span class="n">fhandle</span> <span class="o">=</span> <span class="nb">open</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">fhandle</span><span class="o">.</span><span class="n">read</span>  <span class="p">()</span>
            <span class="n">fhandle</span><span class="o">.</span><span class="n">close</span>  <span class="p">()</span>

            <span class="n">os</span><span class="o">.</span><span class="n">remove</span> <span class="p">(</span><span class="n">fname</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">out</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_exception</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">stage_to_remote</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">cp_flags</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.stage_to_remote"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.stage_to_remote">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :type  src: string</span>
<span class="sd">        :param src: path of local source file to be stage from.</span>
<span class="sd">                    The tgt path is not an URL, but expected to be a path</span>
<span class="sd">                    relative to the current working directory.</span>

<span class="sd">        :type  tgt: string</span>
<span class="sd">        :param tgt: path to target file to stage to.</span>
<span class="sd">                    The tgt path is not an URL, but expected to be a path</span>
<span class="sd">                    relative to the shell&#39;s URL.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># FIXME: make this relative to the shell&#39;s pwd?  Needs pwd in</span>
        <span class="c"># prompt, and updating pwd state on every find_prompt.</span>

        <span class="k">try</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">run_copy_to</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pty_info</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">cp_flags</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_exception</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">stage_from_remote</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">cp_flags</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.stage_from_remote"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.stage_from_remote">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :type  src: string</span>
<span class="sd">        :param tgt: path to source file to stage from.</span>
<span class="sd">                    The tgt path is not an URL, but expected to be a path</span>
<span class="sd">                    relative to the shell&#39;s URL.</span>

<span class="sd">        :type  tgt: string</span>
<span class="sd">        :param src: path of local target file to stage to.</span>
<span class="sd">                    The tgt path is not an URL, but expected to be a path</span>
<span class="sd">                    relative to the current working directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># FIXME: make this relative to the shell&#39;s pwd?  Needs pwd in</span>
        <span class="c"># prompt, and updating pwd state on every find_prompt.</span>

        <span class="k">try</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">run_copy_from</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pty_info</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">cp_flags</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_exception</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">_translate_exception</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="p">:</span></div>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In many cases, we should be able to roughly infer the exception cause</span>
<span class="sd">        from the error message -- this is centrally done in this method.  If</span>
<span class="sd">        possible, it will return a new exception with a more concise error</span>
<span class="sd">        message and appropriate exception type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span>  <span class="ow">not</span> <span class="nb">issubclass</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">se</span><span class="o">.</span><span class="n">SagaException</span><span class="p">)</span> <span class="p">:</span>
            <span class="c"># we do not touch non-saga exceptions</span>
            <span class="k">return</span> <span class="n">e</span>

        <span class="k">if</span>  <span class="ow">not</span> <span class="nb">issubclass</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">se</span><span class="o">.</span><span class="n">NoSuccess</span><span class="p">)</span> <span class="p">:</span>
            <span class="c"># this seems to have a specific cause already, leave it alone</span>
            <span class="k">return</span> <span class="n">e</span>

        <span class="n">cmsg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">_plain_message</span>
        <span class="n">lmsg</span> <span class="o">=</span> <span class="n">cmsg</span><span class="o">.</span><span class="n">lower</span> <span class="p">()</span>

        <span class="k">if</span>  <span class="n">msg</span> <span class="p">:</span>
            <span class="n">cmsg</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&#39;auth&#39;</span> <span class="ow">in</span> <span class="n">lmsg</span> <span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">AuthorizationFailed</span> <span class="p">(</span><span class="n">cmsg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s">&#39;pass&#39;</span> <span class="ow">in</span> <span class="n">lmsg</span> <span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">AuthenticationFailed</span> <span class="p">(</span><span class="n">cmsg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s">&#39;ssh_exchange_identification&#39;</span> <span class="ow">in</span> <span class="n">lmsg</span> <span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">AuthenticationFailed</span> <span class="p">(</span><span class="s">&quot;too frequent login attempts, or sshd misconfiguration: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cmsg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s">&#39;denied&#39;</span> <span class="ow">in</span> <span class="n">lmsg</span> <span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">PermissionDenied</span> <span class="p">(</span><span class="n">cmsg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s">&#39;shared connection&#39;</span> <span class="ow">in</span> <span class="n">lmsg</span> <span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;Insufficient system resources: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cmsg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s">&#39;pty allocation&#39;</span> <span class="ow">in</span> <span class="n">lmsg</span> <span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;Insufficient system resources: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cmsg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s">&#39;Connection to master closed&#39;</span> <span class="ow">in</span> <span class="n">lmsg</span> <span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;Connection failed (insufficient system resources?): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cmsg</span><span class="p">)</span>

        <span class="c"># print e.traceback</span>
        <span class="k">return</span> <span class="n">e</span>


<span class="c"># vim: tabstop=8 expandtab shiftwidth=4 softtabstop=4</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">SAGA 0.1.1-85-g8db36a4 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../saga.html" >saga</a> &raquo;</li> 
      </ul>
    </div>
<div class="footer">
    &copy; Copyright 2012, The SAGA Project.
  Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
  <br />Theme based on <a href="http://readthedocs.org/">Read The Docs</a>

</div>





  </body>
</html>
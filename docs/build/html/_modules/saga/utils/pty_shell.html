

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>saga.utils.pty_shell &mdash; SAGA 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <link rel="top" title="SAGA 1.0 documentation" href="../../../index.html" />
    <link rel="up" title="saga.utils" href="../utils.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">SAGA 1.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../saga.html" >saga</a> &raquo;</li>
          <li><a href="../utils.html" accesskey="U">saga.utils</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for saga.utils.pty_shell</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">saga.utils.pty_process</span>
<span class="kn">import</span> <span class="nn">saga.utils.logger</span>

<span class="n">_PTY_TIMEOUT</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">_SCHEMAS</span>     <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ssh&#39;</span><span class="p">,</span> <span class="s">&#39;gsissh&#39;</span><span class="p">,</span> <span class="s">&#39;fork&#39;</span><span class="p">]</span>

<span class="n">IGNORE</span>   <span class="o">=</span> <span class="mi">0</span>    <span class="c"># discard stdout / stderr</span>
<span class="n">MERGED</span>   <span class="o">=</span> <span class="mi">1</span>    <span class="c"># merge stdout and stderr</span>
<span class="n">SEPARATE</span> <span class="o">=</span> <span class="mi">2</span>    <span class="c"># fetch stdout and stderr individually (one more hop)</span>
<span class="n">STDOUT</span>   <span class="o">=</span> <span class="mi">3</span>    <span class="c"># fetch stdout only, discard stderr</span>
<span class="n">STDERR</span>   <span class="o">=</span> <span class="mi">4</span>    <span class="c"># fetch stderr only, discard stdout</span>

<span class="c"># --------------------------------------------------------------------</span>
<span class="c">#</span>
<span class="k">class</span> <span class="nc">PTYShell</span> <span class="p">(</span><span class="nb">object</span><span class="p">)</span> <span class="p">:</span>
<div class="viewcode-block" id="PTYShell"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class wraps a shell process and runs it as a :class:`PTYProcess`.  The</span>
<span class="sd">    user of this class can start that shell, and run arbitrary commands on it.</span>

<span class="sd">    The shell to be run is expected to be POSIX compliant (bash, csh, sh, zsh</span>
<span class="sd">    etc) -- in particular, we expect the following features:</span>

<span class="sd">      * $?</span>
<span class="sd">      * &gt;&amp; </span>
<span class="sd">      * &gt;&gt;</span>
<span class="sd">      * &gt;</span>
<span class="sd">      * &lt;</span>
<span class="sd">      * 2&gt;&amp;1</span>
<span class="sd">      * |</span>
<span class="sd">      * ||</span>
<span class="sd">      * &amp;&amp;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">contexts</span><span class="o">=</span><span class="p">[],</span> <span class="n">logger</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">url</span>       <span class="o">=</span> <span class="n">url</span>               <span class="c"># describes the shell to run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span>  <span class="o">=</span> <span class="n">contexts</span>          <span class="c"># get security tokens from these</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>    <span class="o">=</span> <span class="n">logger</span>            <span class="c"># possibly log to here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span>    <span class="o">=</span> <span class="s">&quot;^(.*[\$#&gt;])\s*$&quot;</span> <span class="c"># a line ending with # $ &gt;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        
        <span class="c"># need a new logger?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">saga</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">getLogger</span> <span class="p">(</span><span class="s">&#39;PTYShell&#39;</span><span class="p">)</span>

        <span class="n">schema</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">lower</span> <span class="p">()</span>
        <span class="n">sh_type</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">sh_exe</span>  <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">sh_pass</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="c"># find out what type of shell we have to deal with</span>
        <span class="k">if</span>  <span class="n">schema</span>   <span class="o">==</span> <span class="s">&quot;ssh&quot;</span> <span class="p">:</span>
            <span class="n">sh_type</span>  <span class="o">=</span>  <span class="s">&quot;ssh&quot;</span>
            <span class="n">sh_exe</span>   <span class="o">=</span>  <span class="n">saga</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">which</span><span class="o">.</span><span class="n">which</span> <span class="p">(</span><span class="s">&quot;ssh&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">schema</span>  <span class="o">==</span> <span class="s">&quot;gsissh&quot;</span> <span class="p">:</span>
            <span class="n">sh_type</span>  <span class="o">=</span>  <span class="s">&quot;ssh&quot;</span>
            <span class="n">sh_exe</span>   <span class="o">=</span>  <span class="n">saga</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">which</span><span class="o">.</span><span class="n">which</span> <span class="p">(</span><span class="s">&quot;gsissh&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">schema</span>  <span class="o">==</span> <span class="s">&quot;fork&quot;</span> <span class="p">:</span>

            <span class="n">sh_type</span>  <span class="o">=</span>  <span class="s">&quot;sh&quot;</span>
            <span class="k">if</span>  <span class="s">&quot;SHELL&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="p">:</span>
                <span class="n">sh_exe</span> <span class="o">=</span>  <span class="n">saga</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">which</span><span class="o">.</span><span class="n">which</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;SHELL&quot;</span><span class="p">])</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">sh_exe</span> <span class="o">=</span>  <span class="n">saga</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">which</span><span class="o">.</span><span class="n">which</span> <span class="p">(</span><span class="s">&quot;sh&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">BadParameter</span><span class="o">.</span><span class="n">_log</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> \
            	  <span class="s">&quot;PTYShell utility can only handle </span><span class="si">%s</span><span class="s"> schema URLs, not </span><span class="si">%s</span><span class="s">&quot;</span> \
                  <span class="o">%</span> <span class="p">(</span><span class="n">_SCHEMAS</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>



        <span class="c"># make sure we have something to run</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sh_exe</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">BadParameter</span><span class="o">.</span><span class="n">_log</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> \
            	  <span class="s">&quot;adaptor cannot handle </span><span class="si">%s</span><span class="s">:// , no shell exe found&quot;</span> <span class="o">%</span> <span class="n">schema</span><span class="p">)</span>


        <span class="c"># depending on type, create PTYProcess command line (args, env etc)</span>
        <span class="c">#</span>
        <span class="c"># We always set term=vt100 to avoid ansi-escape sequences in the prompt</span>
        <span class="c"># and elsewhere.  Also, we have to make sure that the shell is an</span>
        <span class="c"># interactive login shell, so that it interprets the users startup</span>
        <span class="c"># files, and reacts on commands.</span>
        <span class="k">if</span>  <span class="n">sh_type</span> <span class="o">==</span> <span class="s">&quot;ssh&quot;</span> <span class="p">:</span>

            <span class="n">sh_env</span>  <span class="o">=</span>  <span class="s">&quot;/usr/bin/env TERM=vt100 &quot;</span>  <span class="c"># avoid ansi escapes</span>
            <span class="n">sh_args</span> <span class="o">=</span>  <span class="s">&quot;-t &quot;</span>                       <span class="c"># force pty</span>
            <span class="n">sh_user</span> <span class="o">=</span>  <span class="s">&quot;&quot;</span>                          <span class="c"># use default user id</span>

            <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span> <span class="p">:</span>

                <span class="k">if</span>  <span class="n">context</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span> <span class="p">()</span> <span class="o">==</span> <span class="s">&quot;ssh&quot;</span> <span class="p">:</span>
                    <span class="c"># ssh can handle user_id and user_key of ssh contexts</span>
                    <span class="k">if</span>  <span class="n">schema</span> <span class="o">==</span> <span class="s">&quot;ssh&quot;</span> <span class="p">:</span>
                        <span class="k">if</span>  <span class="n">context</span><span class="o">.</span><span class="n">attribute_exists</span> <span class="p">(</span><span class="s">&quot;user_id&quot;</span><span class="p">)</span> <span class="p">:</span>
                            <span class="n">sh_user</span>  <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">user_id</span>
                        <span class="k">if</span>  <span class="n">context</span><span class="o">.</span><span class="n">attribute_exists</span> <span class="p">(</span><span class="s">&quot;user_key&quot;</span><span class="p">)</span> <span class="p">:</span>
                            <span class="n">sh_args</span> <span class="o">+=</span> <span class="s">&quot;-i </span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">context</span><span class="o">.</span><span class="n">user_key</span>

                <span class="k">if</span>  <span class="n">context</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span> <span class="p">()</span> <span class="o">==</span> <span class="s">&quot;userpass&quot;</span> <span class="p">:</span>
                    <span class="c"># FIXME: ssh should also be able to handle UserPass contexts</span>
                    <span class="k">if</span>  <span class="n">schema</span> <span class="o">==</span> <span class="s">&quot;ssh&quot;</span> <span class="p">:</span>
                        <span class="k">pass</span>

                <span class="k">if</span>  <span class="n">context</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span> <span class="p">()</span> <span class="o">==</span> <span class="s">&quot;gsissh&quot;</span> <span class="p">:</span>
                    <span class="c"># gsissh can handle user_proxy of X509 contexts</span>
                    <span class="c"># FIXME: also use cert_dir etc.</span>
                    <span class="k">if</span>  <span class="n">context</span><span class="o">.</span><span class="n">attribute_exists</span> <span class="p">(</span><span class="s">&quot;user_proxy&quot;</span><span class="p">)</span> <span class="p">:</span>
                        <span class="k">if</span>  <span class="n">schema</span> <span class="o">==</span> <span class="s">&quot;gsissh&quot;</span> <span class="p">:</span>
                            <span class="n">sh_env</span> <span class="o">=</span> <span class="s">&quot;X509_PROXY=&#39;</span><span class="si">%s</span><span class="s">&#39; &quot;</span> <span class="o">%</span> <span class="n">context</span><span class="o">.</span><span class="n">user_proxy</span>

            <span class="c"># all ssh based shells allow for user_id from contexts -- but the</span>
            <span class="c"># username given in the URL takes precedence</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span> <span class="p">:</span>
                <span class="n">sh_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span>

            <span class="k">if</span> <span class="n">sh_user</span> <span class="p">:</span>
                <span class="n">sh_args</span> <span class="o">+=</span> <span class="s">&quot;-l </span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">sh_user</span>

            <span class="c"># build the ssh command line</span>
            <span class="n">sh_cmd</span>  <span class="o">=</span>  <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sh_env</span><span class="p">,</span> <span class="n">sh_exe</span><span class="p">,</span> <span class="n">sh_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>

        <span class="c"># a local shell</span>
        <span class="k">elif</span> <span class="n">sh_type</span> <span class="o">==</span> <span class="s">&quot;sh&quot;</span> <span class="p">:</span>
            <span class="c"># Make sure we have an interactive login shell w/o ansi escapes.</span>
            <span class="n">sh_args</span> <span class="o">=</span>  <span class="s">&quot;-l -i&quot;</span>
            <span class="n">sh_env</span>  <span class="o">=</span>  <span class="s">&quot;/usr/bin/env TERM=vt100&quot;</span>
            <span class="n">sh_cmd</span>  <span class="o">=</span>  <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sh_env</span><span class="p">,</span> <span class="n">sh_exe</span><span class="p">,</span> <span class="n">sh_args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sh_type</span> <span class="o">=</span> <span class="n">sh_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sh_cmd</span>  <span class="o">=</span> <span class="n">sh_cmd</span>

        <span class="c"># we got the shell command - now run it!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open</span> <span class="p">()</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">open</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
<div class="viewcode-block" id="PTYShell.open"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.open">[docs]</a>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="p">(</span><span class="s">&quot;job service opens pty for &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh_cmd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pty</span> <span class="o">=</span> <span class="n">saga</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">pty_process</span><span class="o">.</span><span class="n">PTYProcess</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sh_cmd</span><span class="p">,</span> 
                                                      <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>


        <span class="n">prompt_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;password\s*:\s*$&quot;</span><span class="p">,</span>            <span class="c"># password prompt</span>
                           <span class="s">&quot;want to continue connecting&quot;</span><span class="p">,</span> <span class="c"># hostkey confirmation</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">]</span>                   <span class="c"># native shell prompt </span>
        <span class="c"># FIXME: consider to not do hostkey checks at all (see ssh options)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh_type</span> <span class="o">==</span> <span class="s">&#39;sh&#39;</span> <span class="p">:</span>
            <span class="c"># self.prompt is all we need for local shell, but we keep the other</span>
            <span class="c"># pattern around so that the switch in the while loop below is the</span>
            <span class="c"># same for both shell types</span>
            <span class="c">#</span>
            <span class="c"># prompt_patterns = [self.prompt] </span>
            <span class="k">pass</span>


        <span class="c"># run the shell and find prompt</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">find</span> <span class="p">(</span><span class="n">prompt_patterns</span><span class="p">,</span> <span class="n">_PTY_TIMEOUT</span><span class="p">)</span>

        <span class="c"># this loop will run until we finally find the self.prompt.  At that</span>
        <span class="c"># point, we&#39;ll try to set a different prompt, and when we found that,</span>
        <span class="c"># too, we&#39;ll exit the loop and consider to be ready for running shell</span>
        <span class="c"># commands.</span>
        <span class="k">while</span> <span class="bp">True</span> <span class="p">:</span>

            <span class="c"># we found none of the prompts, yet -- try again if the shell still</span>
            <span class="c"># lives.</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="bp">None</span> <span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">alive</span> <span class="p">()</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;failed to start shell (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">match</span><span class="p">)</span>

                <span class="c"># the write below will make our live simpler, as it will</span>
                <span class="c"># eventually flush I/O buffers, and will make sure that we</span>
                <span class="c"># get a decent prompt -- no matter what stupi^H^H^H^H^H nice</span>
                <span class="c"># PS1 the user invented...</span>
                <span class="c">#</span>
                <span class="c"># FIXME: make sure this does not interfere with the host</span>
                <span class="c"># key and password prompts.  For ssh&#39;s, a simple &#39;\n&#39; might</span>
                <span class="c"># suffice...</span>
              <span class="c"># self.pty.write (&quot;PS1=&#39;PROMPT-$?-&gt;\\n&#39;\nexport PS1\n&quot;)</span>
              <span class="c"># self.pty.write (&quot;\n&quot;)</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">find</span> <span class="p">(</span><span class="n">prompt_patterns</span><span class="p">,</span> <span class="n">_PTY_TIMEOUT</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s">&quot;got password prompt&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sh_pass</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;prompted for unknown password (</span><span class="si">%s</span><span class="s">)&quot;</span> \
                                       <span class="o">%</span> <span class="n">match</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sh_pass</span><span class="p">)</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">find</span> <span class="p">(</span><span class="n">prompt_patterns</span><span class="p">,</span> <span class="n">_PTY_TIMEOUT</span><span class="p">)</span>


            <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s">&quot;got hostkey prompt&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s">&quot;yes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">find</span> <span class="p">(</span><span class="n">prompt_patterns</span><span class="p">,</span> <span class="n">_PTY_TIMEOUT</span><span class="p">)</span>


            <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s">&quot;got initial shell prompt&quot;</span><span class="p">)</span>

                <span class="c"># try to set new prompt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_sync</span> <span class="p">(</span><span class="s">&quot;PS1=&#39;PROMPT-$?-&gt;</span><span class="se">\\</span><span class="s">n&#39;; export PS1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                                <span class="n">new_prompt</span><span class="o">=</span><span class="s">&quot;PROMPT-(\d+)-&gt;\s*$&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s">&quot;got new shell prompt&quot;</span><span class="p">)</span>

                <span class="c"># we are done waiting for a prompt</span>
                <span class="k">break</span>
        

    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">__del__</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span></div>

        <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="p">()</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">close</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
<div class="viewcode-block" id="PTYShell.close"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.close">[docs]</a>
        <span class="k">try</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty</span> <span class="p">:</span> 
                <span class="k">del</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="p">:</span>
            <span class="k">pass</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">alive</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.alive"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.alive">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        alive() checks if the shell is still alive.  duh!</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">alive</span> <span class="p">()</span> <span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
        


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">send</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.send"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.send">[docs]</a>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">find_prompt</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.find_prompt"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.find_prompt">[docs]</a>
        <span class="n">_</span><span class="p">,</span>   <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">find</span>    <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">],</span> <span class="n">_PTY_TIMEOUT</span><span class="p">)</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">txt</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_prompt</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">set_prompt</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.set_prompt"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.set_prompt">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :type  iomode:  string containing a regular expression.</span>
<span class="sd">        :param iomode:  The prompt regex is expected to be a regular expression</span>
<span class="sd">        with one set of catching brackets, which MUST return the previous</span>
<span class="sd">        command&#39;s exit status.  This method will send a newline to the client,</span>
<span class="sd">        and expects to find the prompt with the exit value &#39;0&#39;.</span>

<span class="sd">        As a side effect, this method will discard all previous data on the pty,</span>
<span class="sd">        thus effectively flushing the pty output.  </span>

<span class="sd">        By encoding the exit value in the command prompt, we safe one roundtrip.</span>
<span class="sd">        The prompt on Posix compliant shells can be set, for example, via::</span>

<span class="sd">          PS1=&#39;PROMPT-$?-&gt;\\n&#39;; export PS1</span>

<span class="sd">        The newline in the example above allows to nicely anchor the regular</span>
<span class="sd">        expression, which would look like::</span>

<span class="sd">          PROMPT-(\d+)-&gt;\s*$</span>

<span class="sd">        The regex is compiled with &#39;re.DOTALL&#39;, so the dot character matches</span>
<span class="sd">        all characters, including line breaks.  Be careful not to match more</span>
<span class="sd">        than the exact prompt -- otherwise, a prompt search will swallow stdout</span>
<span class="sd">        data.  For example, the following regex::</span>

<span class="sd">          PROMPT-(.+)-&gt;\s*$</span>

<span class="sd">        would acpture arbitrary strings, and would thus match *all* of::</span>

<span class="sd">          PROMPT-0-&gt; ls</span>
<span class="sd">          data/ info</span>
<span class="sd">          PROMPT-0-&gt;</span>

<span class="sd">        and thus swallow the ls output...</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">old_prompt</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span>    <span class="o">=</span> <span class="n">prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span> <span class="p">(</span><span class="s">&quot;^(.*)</span><span class="si">%s</span><span class="s">\s*$&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>

        <span class="k">try</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s">&quot;true</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

            <span class="c"># FIXME: how do we know that _PTY_TIMOUT suffices?  In particular if</span>
            <span class="c"># we actually need to flush...</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">match</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">find</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">],</span> <span class="n">_PTY_TIMEOUT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">old_prompt</span>
                <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">BadParameter</span> <span class="p">(</span><span class="s">&quot;Cannot use prompt, could not find it&quot;</span><span class="p">)</span>

            <span class="n">ret</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_prompt</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span>

            <span class="k">if</span>  <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">old_prompt</span>
                <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">BadParameter</span> <span class="p">(</span><span class="s">&quot;could not parse exit value (</span><span class="si">%s</span><span class="s">)&quot;</span> \
                                      <span class="o">%</span> <span class="n">match</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">old_prompt</span>
            <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;Could not set prompt (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>



    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">eval_prompt</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">new_prompt</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.eval_prompt"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.eval_prompt">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will match the given data against the current prompt regex,</span>
<span class="sd">        and expects to find an integer as match -- which is then returned, along</span>
<span class="sd">        with all leading data, in a tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">prompt</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span>
        <span class="n">prompt_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_re</span>

        <span class="k">if</span>  <span class="n">new_prompt</span> <span class="p">:</span>
            <span class="n">prompt</span>    <span class="o">=</span> <span class="n">new_prompt</span>
            <span class="n">prompt_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span> <span class="p">(</span><span class="s">&quot;^(.*)</span><span class="si">%s</span><span class="s">\s*$&quot;</span> <span class="o">%</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span> <span class="p">:</span>
            <span class="k">if</span>  <span class="ow">not</span> <span class="n">data</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;could not parse prompt on empty string (</span><span class="si">%s</span><span class="s">) (</span><span class="si">%s</span><span class="s">)&quot;</span> \
                                   <span class="o">%</span> <span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">prompt_re</span><span class="o">.</span><span class="n">match</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span>  <span class="ow">not</span> <span class="n">result</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;could not parse prompt (</span><span class="si">%s</span><span class="s">) (</span><span class="si">%s</span><span class="s">)&quot;</span> \
                                   <span class="o">%</span> <span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

            <span class="k">if</span>  <span class="nb">len</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">groups</span> <span class="p">())</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;prompt does not capture exit value (</span><span class="si">%s</span><span class="s">)&quot;</span>\
                                   <span class="o">%</span> <span class="n">prompt</span><span class="p">)</span>

            <span class="n">txt</span> <span class="o">=</span>     <span class="n">result</span><span class="o">.</span><span class="n">group</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">group</span> <span class="p">(</span><span class="mi">2</span><span class="p">))</span> 

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s">&quot;data   : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s">&quot;prompt : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">prompt</span><span class="p">)</span>

            <span class="k">if</span>  <span class="n">result</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s">&quot;match 1: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="o">.</span><span class="n">group</span> <span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s">&quot;match 2: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="o">.</span><span class="n">group</span> <span class="p">(</span><span class="mi">2</span><span class="p">))</span>

            <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;Could not eval prompt (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>


        <span class="c"># if that worked, we can permanently set new_prompt</span>
        <span class="k">if</span>  <span class="n">new_prompt</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_prompt</span> <span class="p">(</span><span class="n">new_prompt</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>






    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">run_sync</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">iomode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">new_prompt</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.run_sync"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.run_sync">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a shell command, and report exit code, stdout and stderr (all three</span>
<span class="sd">        will be returned in a tuple).  The call will block until the command</span>
<span class="sd">        finishes (more exactly, until we find the prompt again on the shell&#39;s IO</span>
<span class="sd">        stream), and cannot be interrupted.</span>

<span class="sd">        :type  command: string</span>
<span class="sd">        :param command: shell command to run.  We expect the command to not to</span>
<span class="sd">        do stdio redirection, as this is we want to capture that separately.  We</span>
<span class="sd">        *do* allow pipes and stdin/stdout redirection.  Note that SEPARATE mode</span>
<span class="sd">        will break if the job is run in the background</span>

<span class="sd">        :type  iomode:  enum</span>
<span class="sd">        :param iomode:  Defines how stdout and stderr are captured.  The</span>
<span class="sd">        following values are valid:</span>

<span class="sd">          * *IGNORE:*   both stdout and stderr are discarded, `None` will be</span>
<span class="sd">                        returned for each.</span>
<span class="sd">          * *MERGED:*   both streams will be merged and returned as stdout; </span>
<span class="sd">          *             stderr will be `None`.  This is the default.</span>
<span class="sd">          * *SEPARATE:* stdout and stderr will be captured separately, and</span>
<span class="sd">                        returned individually.  Note that this will require </span>
<span class="sd">                        at least one more network hop!  </span>
<span class="sd">          * *STDOUT:*   only stdout is captured, stderr will be `None`.</span>
<span class="sd">          * *STDERR:*   only stderr is captured, stdout will be `None`.</span>
<span class="sd">          * *`None`:*   do not perform any redirection -- this is effectively</span>
<span class="sd">                        the same as `MERGED`</span>

<span class="sd">        If any of the requested output streams does not return any data, an</span>
<span class="sd">        empty string is returned.</span>

<span class="sd">        :type  iomode:  string containing a regular expression.</span>
<span class="sd">        :param iomode:  If the command to be run changes the prompt to be</span>
<span class="sd">        expected for the shell, this parameter MUST contain the regex to be</span>
<span class="sd">        expected.  The same conventions as for set_prompt() hold -- i.e. we</span>
<span class="sd">        expect the prompt regex to capture the exit status of the process.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">strip</span> <span class="p">()</span>
        <span class="k">if</span> <span class="n">command</span><span class="o">.</span><span class="n">endswith</span> <span class="p">(</span><span class="s">&#39;&amp;&#39;</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">BadParameter</span> <span class="p">(</span><span class="s">&quot;can only run foreground jobs (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> \
                                  <span class="o">%</span> <span class="n">command</span><span class="p">)</span>

        <span class="n">redir</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">_err</span>  <span class="o">=</span> <span class="s">&quot;/tmp/saga-python.ssh-job.stderr.$$&quot;</span>

        <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">IGNORE</span> <span class="p">:</span>
            <span class="n">redir</span>  <span class="o">=</span>  <span class="s">&quot; 1&gt;&gt;/dev/null 2&gt;&gt;/dev/null&quot;</span>

        <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">MERGED</span> <span class="p">:</span>
            <span class="n">redir</span>  <span class="o">=</span>  <span class="s">&quot; 2&gt;&amp;1&quot;</span>

        <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">SEPARATE</span> <span class="p">:</span>
            <span class="n">redir</span>  <span class="o">=</span>  <span class="s">&quot; 2&gt;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_err</span>

        <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">STDOUT</span> <span class="p">:</span>
            <span class="n">redir</span>  <span class="o">=</span>  <span class="s">&quot; 2&gt;/dev/null&quot;</span>

        <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">STDERR</span> <span class="p">:</span>
            <span class="n">redir</span>  <span class="o">=</span>  <span class="s">&quot; 2&gt;&amp;1 1&gt;/dev/null&quot;</span>

        <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="bp">None</span> <span class="p">:</span>
            <span class="n">redir</span>  <span class="o">=</span>  <span class="s">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%s%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">redir</span><span class="p">))</span>


        <span class="c"># If given, switch to new prompt pattern right now...</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span>
        <span class="k">if</span>  <span class="n">new_prompt</span> <span class="p">:</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">new_prompt</span>

        <span class="c"># command has been started - now find prompt again.  </span>
        <span class="n">_</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">find</span> <span class="p">([</span><span class="n">prompt</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c"># blocks</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="p">:</span>
            <span class="c"># not find prompt after blocking?  BAD!  Restart the shell</span>
          <span class="c"># self.close ()</span>
            <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;run_sync failed, no prompt (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>


        <span class="n">ret</span><span class="p">,</span> <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_prompt</span> <span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">new_prompt</span><span class="p">)</span>

        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">IGNORE</span> <span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">MERGED</span> <span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span>  <span class="n">txt</span>

        <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">SEPARATE</span> <span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span>  <span class="n">txt</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s">&quot;cat </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_err</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">find</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c"># blocks</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="p">:</span>
                <span class="c"># not find prompt after blocking?  BAD!  Restart the shell</span>
              <span class="c"># self.close ()</span>
                <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;run_sync failed, no prompt (</span><span class="si">%s</span><span class="s">)&quot;</span> \
                                    <span class="o">%</span> <span class="n">command</span><span class="p">)</span>

            <span class="n">_ret</span><span class="p">,</span> <span class="n">_stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_prompt</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span>
            <span class="k">if</span>  <span class="n">_ret</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;run_sync failed, no stderr (</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">)&quot;</span> \
                                   <span class="o">%</span> <span class="p">(</span><span class="n">_ret</span><span class="p">,</span> <span class="n">_stderr</span><span class="p">))</span>
            <span class="n">stderr</span> <span class="o">=</span>  <span class="n">_stderr</span>


        <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">STDOUT</span> <span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span>  <span class="n">txt</span>

        <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="n">STDERR</span> <span class="p">:</span>
            <span class="n">stderr</span> <span class="o">=</span>  <span class="n">txt</span>

        <span class="k">if</span>  <span class="n">iomode</span> <span class="o">==</span> <span class="bp">None</span> <span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span>  <span class="n">txt</span>


        <span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">run_async</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.run_async"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.run_async">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a shell command, but don&#39;t wait for prompt -- just return.  It is up</span>
<span class="sd">        to caller to eventually search for the prompt again.  Meanwhile, the</span>
<span class="sd">        caller can interact with the called command, via the io channels.</span>

<span class="sd">        :type  command: string</span>
<span class="sd">        :param command: shell command to run.  We don&#39;t care if the command is</span>
<span class="sd">        doing i redirection or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">strip</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pty</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>

        <span class="k">return</span>


    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">stage_from_string</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.stage_from_string"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.stage_from_string">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_async</span> <span class="p">(</span><span class="s">&quot;cat &gt; </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tgt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span>      <span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span>      <span class="p">(</span><span class="s">&quot;</span><span class="se">\n\4</span><span class="s">&quot;</span><span class="p">)</span>  <span class="c"># send CTRL-D</span>

        <span class="n">ret</span><span class="p">,</span> <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_prompt</span> <span class="p">()</span>

        <span class="k">if</span>  <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;failed to stage string to file (</span><span class="si">%s</span><span class="s">)(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">txt</span><span class="p">))</span>

    <span class="c"># ----------------------------------------------------------------</span>
    <span class="c">#</span>
    <span class="k">def</span> <span class="nf">stage_to_string</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span> <span class="p">:</span></div>
<div class="viewcode-block" id="PTYShell.stage_to_string"><a class="viewcode-back" href="../../../developers/adaptorwriting.html#saga.utils.pty_shell.PTYShell.stage_to_string">[docs]</a>
        <span class="n">ret</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_sync</span> <span class="p">(</span><span class="s">&quot;cat </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">src</span><span class="p">)</span>

        <span class="k">if</span>  <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="n">saga</span><span class="o">.</span><span class="n">NoSuccess</span> <span class="p">(</span><span class="s">&quot;failed to stage file to string (</span><span class="si">%s</span><span class="s">)(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">out</span>


<span class="c"># vim: tabstop=8 expandtab shiftwidth=4 softtabstop=4</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">SAGA 1.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../saga.html" >saga</a> &raquo;</li>
          <li><a href="../utils.html" >saga.utils</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, The SAGA Project.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>